<?xml version="1.0" encoding="UTF-8"?>
<wsp:Policy xmlns:L7p="http://www.layer7tech.com/ws/policy" xmlns:wsp="http://schemas.xmlsoap.org/ws/2002/12/policy">
    <wsp:All wsp:Usage="Required">
        <L7p:CommentAssertion>
            <L7p:Comment stringValue="Policy Fragment: #OTK Health Check"/>
        </L7p:CommentAssertion>
        <L7p:CustomizeErrorResponse>
            <L7p:Content stringValue="${error.msg}"/>
            <L7p:ContentType stringValue="text/plain"/>
            <L7p:ExtraHeaders nameValuePairArray="included">
                <L7p:item nameValuePair="included">
                    <L7p:Key stringValue="Pragma"/>
                    <L7p:Value stringValue="no-cache"/>
                </L7p:item>
                <L7p:item nameValuePair="included">
                    <L7p:Key stringValue="Cache-Control"/>
                    <L7p:Value stringValue="no-store"/>
                </L7p:item>
                <L7p:item nameValuePair="included">
                    <L7p:Key stringValue="x-ca-err"/>
                    <L7p:Value stringValue="${error.code}"/>
                </L7p:item>
            </L7p:ExtraHeaders>
            <L7p:HttpStatus stringValue="${status}"/>
        </L7p:CustomizeErrorResponse>
        <wsp:All wsp:Usage="Required">
            <L7p:SetVariable>
                <L7p:Base64Expression stringValue="dHJ1ZQ=="/>
                <L7p:VariableToSet stringValue="cleanCreds"/>
            </L7p:SetVariable>
            <L7p:SetVariable>
                <L7p:Base64Expression stringValue="ZmFpbA=="/>
                <L7p:VariableToSet stringValue="clientCheck"/>
            </L7p:SetVariable>
            <L7p:SetVariable>
                <L7p:Base64Expression stringValue="ZmFpbA=="/>
                <L7p:VariableToSet stringValue="accessTokenCheck"/>
            </L7p:SetVariable>
            <L7p:SetVariable>
                <L7p:Base64Expression stringValue="ZmFpbA=="/>
                <L7p:VariableToSet stringValue="idTokenCheck"/>
            </L7p:SetVariable>
            <L7p:SetVariable>
                <L7p:Base64Expression stringValue="ZmFsc2U="/>
                <L7p:VariableToSet stringValue="healthCheckError"/>
            </L7p:SetVariable>
            <L7p:SetVariable>
                <L7p:AssertionComment assertionComment="included">
                    <L7p:Properties mapValue="included">
                        <L7p:entry>
                            <L7p:key stringValue="RIGHT.COMMENT"/>
                            <L7p:value stringValue="// must be url encoded (i.e.: 'scopea scopeb' == 'scopea+scopeb'"/>
                        </L7p:entry>
                    </L7p:Properties>
                </L7p:AssertionComment>
                <L7p:Base64Expression stringValue="aGVhbHRoY2hlY2s="/>
                <L7p:VariableToSet stringValue="scope"/>
            </L7p:SetVariable>
            <L7p:SetVariable>
                <L7p:Base64Expression stringValue="T1RLLUhlYWx0aGNoZWNr"/>
                <L7p:VariableToSet stringValue="client_name"/>
            </L7p:SetVariable>
            <L7p:SetVariable>
                <L7p:AssertionComment assertionComment="included">
                    <L7p:Properties mapValue="included">
                        <L7p:entry>
                            <L7p:key stringValue="RIGHT.COMMENT"/>
                            <L7p:value stringValue="// must be url encoded (i.e.: 'scopea scopeb' == 'scopea+scopeb'"/>
                        </L7p:entry>
                    </L7p:Properties>
                </L7p:AssertionComment>
                <L7p:Base64Expression stringValue="SGVhbHRoY2hlY2tBUEk="/>
                <L7p:VariableToSet stringValue="resource_owner"/>
            </L7p:SetVariable>
        </wsp:All>
        <wsp:All wsp:Usage="Required">
            <L7p:CommentAssertion>
                <L7p:Comment stringValue="Basic Check : Check if OTK DB connnection is working "/>
            </L7p:CommentAssertion>
            <L7p:CommentAssertion>
                <L7p:Comment stringValue="Basic Check : This can be invoked only at localhost. Disable the below line to acccess it from outside  "/>
            </L7p:CommentAssertion>
            <L7p:Encapsulated>
                <L7p:EncapsulatedAssertionConfigGuid stringValue="8b9ded79-cefc-4481-94ab-3cb31ac8136b"/>
                <L7p:EncapsulatedAssertionConfigName stringValue="OTK Version GET"/>
                <L7p:Parameters mapValue="included">
                    <L7p:entry>
                        <L7p:key stringValue="operation"/>
                        <L7p:value stringValue="getOtkVersion"/>
                    </L7p:entry>
                </L7p:Parameters>
            </L7p:Encapsulated>
            <L7p:ComparisonAssertion>
                <L7p:Expression1 stringValue="${otk_version.queryresult.count}"/>
                <L7p:Expression2 stringValue="1"/>
                <L7p:Predicates predicates="included">
                    <L7p:item binary="included">
                        <L7p:RightValue stringValue="1"/>
                    </L7p:item>
                </L7p:Predicates>
            </L7p:ComparisonAssertion>
        </wsp:All>
        <wsp:OneOrMore wsp:Usage="Required">
            <L7p:ComparisonAssertion>
                <L7p:CaseSensitive booleanValue="false"/>
                <L7p:Expression1 stringValue="${check_type}"/>
                <L7p:Expression2 stringValue="basic"/>
                <L7p:ExpressionIsVariable booleanValue="false"/>
                <L7p:Predicates predicates="included">
                    <L7p:item binary="included">
                        <L7p:CaseSensitive booleanValue="false"/>
                        <L7p:RightValue stringValue="basic"/>
                    </L7p:item>
                </L7p:Predicates>
            </L7p:ComparisonAssertion>
            <wsp:All wsp:Usage="Required">
                <wsp:OneOrMore wsp:Usage="Required">
                    <L7p:ComparisonAssertion>
                        <L7p:CaseSensitive booleanValue="false"/>
                        <L7p:Expression1 stringValue="${client_id}"/>
                        <L7p:Expression2 stringValue="${gateway.otk.health.apikey}"/>
                        <L7p:ExpressionIsVariable booleanValue="false"/>
                        <L7p:Negate booleanValue="true"/>
                        <L7p:Operator operator="EMPTY"/>
                        <L7p:Predicates predicates="included">
                            <L7p:item binary="included">
                                <L7p:CaseSensitive booleanValue="false"/>
                                <L7p:Negated booleanValue="true"/>
                                <L7p:Operator operator="EMPTY"/>
                                <L7p:RightValue stringValue="${gateway.otk.health.apikey}"/>
                            </L7p:item>
                        </L7p:Predicates>
                    </L7p:ComparisonAssertion>
                    <L7p:Encapsulated>
                        <L7p:EncapsulatedAssertionConfigGuid stringValue="56bd8147-3ab4-4d09-9460-8b2de02b7a9e"/>
                        <L7p:EncapsulatedAssertionConfigName stringValue="OTK Fail with error message"/>
                        <L7p:Parameters mapValue="included">
                            <L7p:entry>
                                <L7p:key stringValue="apiPrefix"/>
                                <L7p:value stringValue=""/>
                            </L7p:entry>
                            <L7p:entry>
                                <L7p:key stringValue="custom"/>
                                <L7p:value stringValue=""/>
                            </L7p:entry>
                            <L7p:entry>
                                <L7p:key stringValue="givenErrorCode"/>
                                <L7p:value stringValue="103"/>
                            </L7p:entry>
                        </L7p:Parameters>
                    </L7p:Encapsulated>
                    <wsp:All wsp:Usage="Required">
                        <L7p:Regex>
                            <L7p:AutoTarget booleanValue="false"/>
                            <L7p:OtherTargetMessageVariable stringValue="error.msg"/>
                            <L7p:Regex stringValue="Missing or duplicate parameters"/>
                            <L7p:Replace booleanValue="true"/>
                            <L7p:Replacement stringValue="invalid parameters : client_id"/>
                            <L7p:Target target="OTHER"/>
                        </L7p:Regex>
                        <L7p:AuditDetailAssertion>
                            <L7p:Detail stringValue="client_id is empty."/>
                        </L7p:AuditDetailAssertion>
                        <L7p:FalseAssertion/>
                    </wsp:All>
                </wsp:OneOrMore>
                <wsp:OneOrMore wsp:Usage="Required">
                    <L7p:ComparisonAssertion>
                        <L7p:CaseSensitive booleanValue="false"/>
                        <L7p:Expression1 stringValue="${gateway.otk.health.apikey}"/>
                        <L7p:Expression2 stringValue="${gateway.otk.health.apikey}"/>
                        <L7p:ExpressionIsVariable booleanValue="false"/>
                        <L7p:Negate booleanValue="true"/>
                        <L7p:Operator operator="EMPTY"/>
                        <L7p:Predicates predicates="included">
                            <L7p:item binary="included">
                                <L7p:CaseSensitive booleanValue="false"/>
                                <L7p:Negated booleanValue="true"/>
                                <L7p:Operator operator="EMPTY"/>
                                <L7p:RightValue stringValue="${gateway.otk.health.apikey}"/>
                            </L7p:item>
                        </L7p:Predicates>
                    </L7p:ComparisonAssertion>
                    <L7p:Encapsulated>
                        <L7p:EncapsulatedAssertionConfigGuid stringValue="56bd8147-3ab4-4d09-9460-8b2de02b7a9e"/>
                        <L7p:EncapsulatedAssertionConfigName stringValue="OTK Fail with error message"/>
                        <L7p:Parameters mapValue="included">
                            <L7p:entry>
                                <L7p:key stringValue="apiPrefix"/>
                                <L7p:value stringValue=""/>
                            </L7p:entry>
                            <L7p:entry>
                                <L7p:key stringValue="custom"/>
                                <L7p:value stringValue=""/>
                            </L7p:entry>
                            <L7p:entry>
                                <L7p:key stringValue="givenErrorCode"/>
                                <L7p:value stringValue="000"/>
                            </L7p:entry>
                        </L7p:Parameters>
                    </L7p:Encapsulated>
                    <wsp:All wsp:Usage="Required">
                        <L7p:AuditDetailAssertion>
                            <L7p:Detail stringValue="API key has not been set"/>
                        </L7p:AuditDetailAssertion>
                        <L7p:Regex>
                            <L7p:AutoTarget booleanValue="false"/>
                            <L7p:OtherTargetMessageVariable stringValue="error.msg"/>
                            <L7p:Regex stringValue="The request failed due to some unknown reason"/>
                            <L7p:Replace booleanValue="true"/>
                            <L7p:Replacement stringValue="The server configuration is invalid. Missing otk health api key. Contact the administrator"/>
                            <L7p:Target target="OTHER"/>
                        </L7p:Regex>
                        <L7p:FalseAssertion/>
                    </wsp:All>
                </wsp:OneOrMore>
                <wsp:OneOrMore wsp:Usage="Required">
                    <L7p:ComparisonAssertion>
                        <L7p:CaseSensitive booleanValue="false"/>
                        <L7p:Expression1 stringValue="${api_key}"/>
                        <L7p:Expression2 stringValue="${gateway.otk.health.apikey}"/>
                        <L7p:ExpressionIsVariable booleanValue="false"/>
                        <L7p:Predicates predicates="included">
                            <L7p:item binary="included">
                                <L7p:CaseSensitive booleanValue="false"/>
                                <L7p:RightValue stringValue="${gateway.otk.health.apikey}"/>
                            </L7p:item>
                        </L7p:Predicates>
                    </L7p:ComparisonAssertion>
                    <L7p:Encapsulated>
                        <L7p:EncapsulatedAssertionConfigGuid stringValue="56bd8147-3ab4-4d09-9460-8b2de02b7a9e"/>
                        <L7p:EncapsulatedAssertionConfigName stringValue="OTK Fail with error message"/>
                        <L7p:Parameters mapValue="included">
                            <L7p:entry>
                                <L7p:key stringValue="apiPrefix"/>
                                <L7p:value stringValue=""/>
                            </L7p:entry>
                            <L7p:entry>
                                <L7p:key stringValue="custom"/>
                                <L7p:value stringValue=""/>
                            </L7p:entry>
                            <L7p:entry>
                                <L7p:key stringValue="givenErrorCode"/>
                                <L7p:value stringValue="103"/>
                            </L7p:entry>
                        </L7p:Parameters>
                    </L7p:Encapsulated>
                    <wsp:All wsp:Usage="Required">
                        <L7p:Regex>
                            <L7p:AutoTarget booleanValue="false"/>
                            <L7p:OtherTargetMessageVariable stringValue="error.msg"/>
                            <L7p:Regex stringValue="Missing or duplicate parameters"/>
                            <L7p:Replace booleanValue="true"/>
                            <L7p:Replacement stringValue="invalid parameters : api key"/>
                            <L7p:Target target="OTHER"/>
                        </L7p:Regex>
                        <L7p:AuditDetailAssertion>
                            <L7p:Detail stringValue="API key provided was invalid, given: '${api_key}'"/>
                        </L7p:AuditDetailAssertion>
                        <L7p:FalseAssertion/>
                    </wsp:All>
                </wsp:OneOrMore>
                <L7p:Include>
                    <L7p:PolicyGuid stringValue="fd9342d8-5086-4758-8fd3-caa2df094448"/>
                    <L7p:PolicyName stringValue="OTK Apply Ratelimit Extension"/>
                </L7p:Include>
                <wsp:OneOrMore wsp:Usage="Required">
                    <wsp:All wsp:Usage="Required">
                        <wsp:OneOrMore wsp:Usage="Required">
                            <wsp:All wsp:Usage="Required">
                                <L7p:Encapsulated>
                                    <L7p:EncapsulatedAssertionConfigGuid stringValue="290511a8-b775-47a7-98ab-7be386da2105"/>
                                    <L7p:EncapsulatedAssertionConfigName stringValue="OTK Client GET"/>
                                    <L7p:Parameters mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="client_ident"/>
                                    <L7p:value stringValue=""/>
                                    </L7p:entry>
                                    <L7p:entry>
                                    <L7p:key stringValue="client_key"/>
                                    <L7p:value stringValue="${client_id}"/>
                                    </L7p:entry>
                                    <L7p:entry>
                                    <L7p:key stringValue="custom"/>
                                    <L7p:value stringValue=""/>
                                    </L7p:entry>
                                    <L7p:entry>
                                    <L7p:key stringValue="environment"/>
                                    <L7p:value stringValue=""/>
                                    </L7p:entry>
                                    <L7p:entry>
                                    <L7p:key stringValue="filterStatus"/>
                                    <L7p:value stringValue=""/>
                                    </L7p:entry>
                                    <L7p:entry>
                                    <L7p:key stringValue="format"/>
                                    <L7p:value stringValue=""/>
                                    </L7p:entry>
                                    <L7p:entry>
                                    <L7p:key stringValue="master"/>
                                    <L7p:value stringValue=""/>
                                    </L7p:entry>
                                    <L7p:entry>
                                    <L7p:key stringValue="name"/>
                                    <L7p:value stringValue=""/>
                                    </L7p:entry>
                                    <L7p:entry>
                                    <L7p:key stringValue="operation"/>
                                    <L7p:value stringValue="getKey"/>
                                    </L7p:entry>
                                    <L7p:entry>
                                    <L7p:key stringValue="org"/>
                                    <L7p:value stringValue=""/>
                                    </L7p:entry>
                                    <L7p:entry>
                                    <L7p:key stringValue="queryOffset"/>
                                    <L7p:value stringValue=""/>
                                    </L7p:entry>
                                    <L7p:entry>
                                    <L7p:key stringValue="registered_by"/>
                                    <L7p:value stringValue=""/>
                                    </L7p:entry>
                                    </L7p:Parameters>
                                </L7p:Encapsulated>
                                <L7p:ComparisonAssertion>
                                    <L7p:CaseSensitive booleanValue="false"/>
                                    <L7p:Expression1 stringValue="${error.code}"/>
                                    <L7p:Expression2 stringValue=""/>
                                    <L7p:ExpressionIsVariable booleanValue="false"/>
                                    <L7p:Operator operator="EMPTY"/>
                                    <L7p:Predicates predicates="included">
                                    <L7p:item binary="included">
                                    <L7p:CaseSensitive booleanValue="false"/>
                                    <L7p:Operator operator="EMPTY"/>
                                    <L7p:RightValue stringValue=""/>
                                    </L7p:item>
                                    </L7p:Predicates>
                                </L7p:ComparisonAssertion>
                                <L7p:ResponseXpathAssertion>
                                    <L7p:VariablePrefix stringValue="xpathClientId"/>
                                    <L7p:XmlMsgSrc stringValue="resp"/>
                                    <L7p:XpathExpression xpathExpressionValue="included">
                                    <L7p:Expression stringValue="/ns:values/ns:value/ns:client_ident"/>
                                    <L7p:Namespaces mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="ns"/>
                                    <L7p:value stringValue="http://ns.l7tech.com/2012/11/otk-clientstore"/>
                                    </L7p:entry>
                                    <L7p:entry>
                                    <L7p:key stringValue="s"/>
                                    <L7p:value stringValue="http://schemas.xmlsoap.org/soap/envelope/"/>
                                    </L7p:entry>
                                    </L7p:Namespaces>
                                    <L7p:XpathVersion xpathVersion="XPATH_1_0"/>
                                    </L7p:XpathExpression>
                                </L7p:ResponseXpathAssertion>
                                <L7p:ComparisonAssertion>
                                    <L7p:CaseSensitive booleanValue="false"/>
                                    <L7p:Expression1 stringValue="${xpathClientId.found}"/>
                                    <L7p:Expression2 stringValue="true"/>
                                    <L7p:Predicates predicates="included">
                                    <L7p:item binary="included">
                                    <L7p:CaseSensitive booleanValue="false"/>
                                    <L7p:RightValue stringValue="true"/>
                                    </L7p:item>
                                    </L7p:Predicates>
                                </L7p:ComparisonAssertion>
                                <L7p:ResponseXpathAssertion>
                                    <L7p:VariablePrefix stringValue="xpathScope"/>
                                    <L7p:XmlMsgSrc stringValue="resp"/>
                                    <L7p:XpathExpression xpathExpressionValue="included">
                                    <L7p:Expression stringValue="/ns:values/ns:value/ns:scope"/>
                                    <L7p:Namespaces mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="ns"/>
                                    <L7p:value stringValue="http://ns.l7tech.com/2012/11/otk-clientstore"/>
                                    </L7p:entry>
                                    <L7p:entry>
                                    <L7p:key stringValue="s"/>
                                    <L7p:value stringValue="http://schemas.xmlsoap.org/soap/envelope/"/>
                                    </L7p:entry>
                                    </L7p:Namespaces>
                                    <L7p:XpathVersion xpathVersion="XPATH_1_0"/>
                                    </L7p:XpathExpression>
                                </L7p:ResponseXpathAssertion>
                                <L7p:ResponseXpathAssertion>
                                    <L7p:VariablePrefix stringValue="xpathSecret"/>
                                    <L7p:XmlMsgSrc stringValue="resp"/>
                                    <L7p:XpathExpression xpathExpressionValue="included">
                                    <L7p:Expression stringValue="/ns:values/ns:value/ns:secret"/>
                                    <L7p:Namespaces mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="ns"/>
                                    <L7p:value stringValue="http://ns.l7tech.com/2012/11/otk-clientstore"/>
                                    </L7p:entry>
                                    <L7p:entry>
                                    <L7p:key stringValue="s"/>
                                    <L7p:value stringValue="http://schemas.xmlsoap.org/soap/envelope/"/>
                                    </L7p:entry>
                                    </L7p:Namespaces>
                                    <L7p:XpathVersion xpathVersion="XPATH_1_0"/>
                                    </L7p:XpathExpression>
                                </L7p:ResponseXpathAssertion>
                                <L7p:SetVariable>
                                    <L7p:Base64Expression stringValue="JHt4cGF0aENsaWVudElkLnJlc3VsdH0="/>
                                    <L7p:VariableToSet stringValue="client_id"/>
                                </L7p:SetVariable>
                                <L7p:SetVariable>
                                    <L7p:Base64Expression stringValue="JHt4cGF0aFNlY3JldC5yZXN1bHR9"/>
                                    <L7p:VariableToSet stringValue="client_secret"/>
                                </L7p:SetVariable>
                                <L7p:SetVariable>
                                    <L7p:Base64Expression stringValue="JHt4cGF0aFNjb3BlLnJlc3VsdH0="/>
                                    <L7p:VariableToSet stringValue="scope"/>
                                </L7p:SetVariable>
                            </wsp:All>
                            <wsp:All wsp:Usage="Required">
                                <L7p:Encapsulated>
                                    <L7p:EncapsulatedAssertionConfigGuid stringValue="6dbc70f9-bb40-4a69-a0ec-88fae4f35300"/>
                                    <L7p:EncapsulatedAssertionConfigName stringValue="OTK Generate OAuth Token"/>
                                    <L7p:Parameters mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="ac"/>
                                    <L7p:value stringValue="false"/>
                                    </L7p:entry>
                                    <L7p:entry>
                                    <L7p:key stringValue="art"/>
                                    <L7p:value stringValue="false"/>
                                    </L7p:entry>
                                    <L7p:entry>
                                    <L7p:key stringValue="at"/>
                                    <L7p:value stringValue="false"/>
                                    </L7p:entry>
                                    <L7p:entry>
                                    <L7p:key stringValue="cid"/>
                                    <L7p:value stringValue="true"/>
                                    </L7p:entry>
                                    <L7p:entry>
                                    <L7p:key stringValue="cidm"/>
                                    <L7p:value stringValue="false"/>
                                    </L7p:entry>
                                    <L7p:entry>
                                    <L7p:key stringValue="custom"/>
                                    <L7p:value stringValue=""/>
                                    </L7p:entry>
                                    <L7p:entry>
                                    <L7p:key stringValue="ock"/>
                                    <L7p:value stringValue="false"/>
                                    </L7p:entry>
                                    <L7p:entry>
                                    <L7p:key stringValue="ot"/>
                                    <L7p:value stringValue="false"/>
                                    </L7p:entry>
                                    <L7p:entry>
                                    <L7p:key stringValue="rft"/>
                                    <L7p:value stringValue="false"/>
                                    </L7p:entry>
                                    <L7p:entry>
                                    <L7p:key stringValue="urt"/>
                                    <L7p:value stringValue="false"/>
                                    </L7p:entry>
                                    </L7p:Parameters>
                                </L7p:Encapsulated>
                                <L7p:SetVariable>
                                    <L7p:Base64Expression stringValue="JHtnZW5TZWNyZXR9"/>
                                    <L7p:VariableToSet stringValue="client_secret"/>
                                </L7p:SetVariable>
                                <wsp:All wsp:Usage="Required">
                                    <L7p:Encapsulated>

                                    <L7p:EncapsulatedAssertionConfigGuid stringValue="71e2d996-cea5-4862-ad46-7b50c0d36c84"/>

                                    <L7p:EncapsulatedAssertionConfigName stringValue="OTK Client Persist"/>
                                    <L7p:Parameters mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="account_plan_mapping_ids"/>
                                    <L7p:value stringValue=""/>
                                    </L7p:entry>
                                    <L7p:entry>
                                    <L7p:key stringValue="callback"/>
                                    <L7p:value stringValue="https://localhost"/>
                                    </L7p:entry>
                                    <L7p:entry>
                                    <L7p:key stringValue="client_custom"/>
                                    <L7p:value stringValue="{}"/>
                                    </L7p:entry>
                                    <L7p:entry>
                                    <L7p:key stringValue="client_ident"/>
                                    <L7p:value stringValue="${client_id}"/>
                                    </L7p:entry>
                                    <L7p:entry>
                                    <L7p:key stringValue="client_key"/>
                                    <L7p:value stringValue="${client_id}"/>
                                    </L7p:entry>
                                    <L7p:entry>
                                    <L7p:key stringValue="client_name"/>
                                    <L7p:value stringValue="${client_name}"/>
                                    </L7p:entry>
                                    <L7p:entry>
                                    <L7p:key stringValue="client_secret"/>
                                    <L7p:value stringValue="${client_secret}"/>
                                    </L7p:entry>
                                    <L7p:entry>
                                    <L7p:key stringValue="client_status"/>
                                    <L7p:value stringValue="ENABLED"/>
                                    </L7p:entry>
                                    <L7p:entry>
                                    <L7p:key stringValue="custom"/>
                                    <L7p:value stringValue="{}"/>
                                    </L7p:entry>
                                    <L7p:entry>
                                    <L7p:key stringValue="description"/>
                                    <L7p:value stringValue="Test client for automated healthcheck"/>
                                    </L7p:entry>
                                    <L7p:entry>
                                    <L7p:key stringValue="environment"/>
                                    <L7p:value stringValue="ALL"/>
                                    </L7p:entry>
                                    <L7p:entry>
                                    <L7p:key stringValue="expiration"/>
                                    <L7p:value stringValue="0"/>
                                    </L7p:entry>
                                    <L7p:entry>
                                    <L7p:key stringValue="key_custom"/>
                                    <L7p:value stringValue="{}"/>
                                    </L7p:entry>
                                    <L7p:entry>
                                    <L7p:key stringValue="org"/>
                                    <L7p:value stringValue="CA Technologies"/>
                                    </L7p:entry>
                                    <L7p:entry>
                                    <L7p:key stringValue="persist_client"/>
                                    <L7p:value stringValue="false"/>
                                    </L7p:entry>
                                    <L7p:entry>
                                    <L7p:key stringValue="persist_client_and_key"/>
                                    <L7p:value stringValue="true"/>
                                    </L7p:entry>
                                    <L7p:entry>
                                    <L7p:key stringValue="persist_client_key"/>
                                    <L7p:value stringValue="false"/>
                                    </L7p:entry>
                                    <L7p:entry>
                                    <L7p:key stringValue="registered_by"/>
                                    <L7p:value stringValue="${resource_owner}"/>
                                    </L7p:entry>
                                    <L7p:entry>
                                    <L7p:key stringValue="scope"/>
                                    <L7p:value stringValue="${scope}"/>
                                    </L7p:entry>
                                    <L7p:entry>
                                    <L7p:key stringValue="service_ids"/>
                                    <L7p:value stringValue=""/>
                                    </L7p:entry>
                                    <L7p:entry>
                                    <L7p:key stringValue="type"/>
                                    <L7p:value stringValue="confidential"/>
                                    </L7p:entry>
                                    </L7p:Parameters>
                                    </L7p:Encapsulated>
                                    <L7p:SetVariable>
                                    <L7p:Base64Expression stringValue="cGFzcw=="/>
                                    <L7p:VariableToSet stringValue="clientCheck"/>
                                    </L7p:SetVariable>
                                </wsp:All>
                            </wsp:All>
                            <wsp:All wsp:Usage="Required">
                                <L7p:AuditDetailAssertion>
                                    <L7p:Detail stringValueReference="inline"><![CDATA[Persisting client failed:
                ${error.msg}]]></L7p:Detail>
                                    <L7p:LoggingOnly booleanValue="true"/>
                                </L7p:AuditDetailAssertion>
                                <L7p:SetVariable>
                                    <L7p:Base64Expression stringValue="dHJ1ZQ=="/>
                                    <L7p:VariableToSet stringValue="healthCheckError"/>
                                </L7p:SetVariable>
                                <L7p:FalseAssertion/>
                            </wsp:All>
                        </wsp:OneOrMore>
                        <wsp:All wsp:Usage="Required">
                            <L7p:Encapsulated>
                                <L7p:EncapsulatedAssertionConfigGuid stringValue="2e6e2ef3-a36f-4548-a2c4-7b369b7ae184"/>
                                <L7p:EncapsulatedAssertionConfigName stringValue="OTK Variable Configuration"/>
                                <L7p:Parameters mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="custom"/>
                                    <L7p:value stringValue=""/>
                                    </L7p:entry>
                                </L7p:Parameters>
                            </L7p:Encapsulated>
                            <wsp:OneOrMore wsp:Usage="Required">
                                <wsp:All wsp:Usage="Required">
                                    <L7p:ComparisonAssertion>
                                    <L7p:CaseSensitive booleanValue="false"/>
                                    <L7p:Expression1 stringValue="${gateway.otk.port.health}"/>
                                    <L7p:Expression2 stringValue=""/>
                                    <L7p:ExpressionIsVariable booleanValue="false"/>
                                    <L7p:Negate booleanValue="true"/>
                                    <L7p:Operator operator="EMPTY"/>
                                    <L7p:Predicates predicates="included">
                                    <L7p:item binary="included">
                                    <L7p:CaseSensitive booleanValue="false"/>
                                    <L7p:Negated booleanValue="true"/>
                                    <L7p:Operator operator="EMPTY"/>
                                    <L7p:RightValue stringValue=""/>
                                    </L7p:item>
                                    </L7p:Predicates>
                                    </L7p:ComparisonAssertion>
                                    <L7p:SetVariable>
                                    <L7p:Base64Expression stringValue="aHR0cHM6Ly8ke2dhdGV3YXkuY2x1c3Rlci5ob3N0bmFtZX06JHtnYXRld2F5Lm90ay5wb3J0LmhlYWx0aH0="/>
                                    <L7p:VariableToSet stringValue="url"/>
                                    </L7p:SetVariable>
                                </wsp:All>
                                <L7p:SetVariable>
                                    <L7p:Base64Expression stringValue="aHR0cHM6Ly8ke2dhdGV3YXkuY2x1c3Rlci5ob3N0bmFtZX0="/>
                                    <L7p:VariableToSet stringValue="url"/>
                                </L7p:SetVariable>
                            </wsp:OneOrMore>
                            <wsp:OneOrMore wsp:Usage="Required">
                                <L7p:ComparisonAssertion>
                                    <L7p:CaseSensitive booleanValue="false"/>
                                    <L7p:Expression1 stringValue="${oauth2_server_url_prefix}"/>
                                    <L7p:Expression2 stringValue=""/>
                                    <L7p:Operator operator="EMPTY"/>
                                    <L7p:Predicates predicates="included">
                                    <L7p:item binary="included">
                                    <L7p:CaseSensitive booleanValue="false"/>
                                    <L7p:Operator operator="EMPTY"/>
                                    <L7p:RightValue stringValue=""/>
                                    </L7p:item>
                                    </L7p:Predicates>
                                </L7p:ComparisonAssertion>
                                <L7p:SetVariable>
                                    <L7p:Base64Expression stringValue="JHt1cmx9LyR7b2F1dGgyX3NlcnZlcl91cmxfcHJlZml4fQ=="/>
                                    <L7p:VariableToSet stringValue="url"/>
                                </L7p:SetVariable>
                            </wsp:OneOrMore>
                        </wsp:All>
                        <L7p:CommentAssertion>
                            <L7p:Comment stringValue="Basic check: use grant_type=client_credentials"/>
                        </L7p:CommentAssertion>
                        <wsp:OneOrMore wsp:Usage="Required">
                            <wsp:All wsp:Usage="Required">
                                <L7p:SetVariable>
                                    <L7p:Base64Expression stringValue="Y2xpZW50X2lkPSR7Y2xpZW50X2lkfSZjbGllbnRfc2VjcmV0PSR7Y2xpZW50X3NlY3JldH0mZ3JhbnRfdHlwZT1jbGllbnRfY3JlZGVudGlhbHMmc2NvcGU9JHtzY29wZX0="/>
                                    <L7p:ContentType stringValue="application/x-www-form-urlencoded; charset=utf-8"/>
                                    <L7p:DataType variableDataType="message"/>
                                    <L7p:VariableToSet stringValue="msg"/>
                                </L7p:SetVariable>
                                <L7p:HttpRoutingAssertion>
                                    <L7p:CurrentSecurityHeaderHandling intValue="3"/>
                                    <L7p:HttpMethod httpMethod="POST"/>
                                    <L7p:ProtectedServiceUrl stringValue="${url}/auth/oauth/v2/token"/>
                                    <L7p:ProxyPassword stringValueNull="null"/>
                                    <L7p:ProxyUsername stringValueNull="null"/>
                                    <L7p:RequestHeaderRules httpPassthroughRuleSet="included">
                                    <L7p:ForwardAll booleanValue="true"/>
                                    <L7p:Rules httpPassthroughRules="included">
                                    <L7p:item httpPassthroughRule="included">
                                    <L7p:Name stringValue="Cookie"/>
                                    </L7p:item>
                                    <L7p:item httpPassthroughRule="included">
                                    <L7p:Name stringValue="SOAPAction"/>
                                    </L7p:item>
                                    </L7p:Rules>
                                    </L7p:RequestHeaderRules>
                                    <L7p:RequestMsgSrc stringValue="msg"/>
                                    <L7p:RequestParamRules httpPassthroughRuleSet="included">
                                    <L7p:ForwardAll booleanValue="true"/>
                                    <L7p:Rules httpPassthroughRules="included"/>
                                    </L7p:RequestParamRules>
                                    <L7p:ResponseHeaderRules httpPassthroughRuleSet="included">
                                    <L7p:ForwardAll booleanValue="true"/>
                                    <L7p:Rules httpPassthroughRules="included">
                                    <L7p:item httpPassthroughRule="included">
                                    <L7p:Name stringValue="Set-Cookie"/>
                                    </L7p:item>
                                    </L7p:Rules>
                                    </L7p:ResponseHeaderRules>
                                    <L7p:ResponseMsgDest stringValue="resp"/>
                                    <L7p:SamlAssertionVersion intValue="2"/>
                                </L7p:HttpRoutingAssertion>
                                <L7p:ComparisonAssertion>
                                    <L7p:Expression1 stringValue="${resp.mainpart}"/>
                                    <L7p:Expression2 stringValue="access_token"/>
                                    <L7p:Operator operator="CONTAINS"/>
                                    <L7p:Predicates predicates="included">
                                    <L7p:item binary="included">
                                    <L7p:Operator operator="CONTAINS"/>
                                    <L7p:RightValue stringValue="access_token"/>
                                    </L7p:item>
                                    </L7p:Predicates>
                                </L7p:ComparisonAssertion>
                                <L7p:SetVariable>
                                    <L7p:Base64Expression stringValue="cGFzcw=="/>
                                    <L7p:VariableToSet stringValue="accessTokenCheck"/>
                                </L7p:SetVariable>
                            </wsp:All>
                            <wsp:All wsp:Usage="Required">
                                <L7p:AuditDetailAssertion>
                                    <L7p:Detail stringValueReference="inline"><![CDATA[Basic check failed:
                Token request to '${url}/auth/oauth/v2/token' using 'grant_type=client_credentials' failed!]]></L7p:Detail>
                                </L7p:AuditDetailAssertion>
                                <L7p:SetVariable>
                                    <L7p:Base64Expression stringValue="dHJ1ZQ=="/>
                                    <L7p:VariableToSet stringValue="healthCheckError"/>
                                </L7p:SetVariable>
                                <L7p:FalseAssertion/>
                            </wsp:All>
                        </wsp:OneOrMore>
                        <wsp:OneOrMore wsp:Usage="Required">
                            <wsp:OneOrMore wsp:Usage="Required">
                                <L7p:ComparisonAssertion>
                                    <L7p:CaseSensitive booleanValue="false"/>
                                    <L7p:Expression1 stringValue="${accessTokenCheck}"/>
                                    <L7p:Operator operatorNull="null"/>
                                    <L7p:Predicates predicates="included">
                                    <L7p:item dataType="included">
                                    <L7p:Type variableDataType="string"/>
                                    </L7p:item>
                                    <L7p:item binary="included">
                                    <L7p:Operator operator="NE"/>
                                    <L7p:RightValue stringValue="pass"/>
                                    </L7p:item>
                                    </L7p:Predicates>
                                </L7p:ComparisonAssertion>
                                <L7p:Encapsulated>
                                    <L7p:AssertionComment assertionComment="included">
                                    <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="RIGHT.COMMENT"/>
                                    <L7p:value stringValue="// access_token, refresh_token"/>
                                    </L7p:entry>
                                    </L7p:Properties>
                                    </L7p:AssertionComment>
                                    <L7p:EncapsulatedAssertionConfigGuid stringValue="ada963ed-0428-4ead-8576-9ef79193752c"/>
                                    <L7p:EncapsulatedAssertionConfigName stringValue="OTK Token Delete"/>
                                    <L7p:Parameters mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="access_token"/>
                                    <L7p:value stringValue=""/>
                                    </L7p:entry>
                                    <L7p:entry>
                                    <L7p:key stringValue="client_key"/>
                                    <L7p:value stringValue="${client_id}"/>
                                    </L7p:entry>
                                    <L7p:entry>
                                    <L7p:key stringValue="custom"/>
                                    <L7p:value stringValue=""/>
                                    </L7p:entry>
                                    <L7p:entry>
                                    <L7p:key stringValue="refresh_token"/>
                                    <L7p:value stringValue=""/>
                                    </L7p:entry>
                                    <L7p:entry>
                                    <L7p:key stringValue="temp_token"/>
                                    <L7p:value stringValue=""/>
                                    </L7p:entry>
                                    </L7p:Parameters>
                                </L7p:Encapsulated>
                            </wsp:OneOrMore>
                            <wsp:All wsp:Usage="Required">
                                <L7p:AuditDetailAssertion>
                                    <L7p:Detail stringValueReference="inline"><![CDATA[Clean up task failed:
                ${error.msg}]]></L7p:Detail>
                                </L7p:AuditDetailAssertion>
                                <L7p:SetVariable>
                                    <L7p:Base64Expression stringValue="dHJ1ZQ=="/>
                                    <L7p:VariableToSet stringValue="healthCheckError"/>
                                </L7p:SetVariable>
                                <L7p:FalseAssertion/>
                            </wsp:All>
                        </wsp:OneOrMore>
                    </wsp:All>
                </wsp:OneOrMore>
            </wsp:All>
        </wsp:OneOrMore>
    </wsp:All>
</wsp:Policy>
