<?xml version="1.0" encoding="UTF-8"?>
<wsp:Policy xmlns:L7p="http://www.layer7tech.com/ws/policy" xmlns:wsp="http://schemas.xmlsoap.org/ws/2002/12/policy">
    <wsp:All wsp:Usage="Required">
        <L7p:CommentAssertion>
            <L7p:Comment stringValue=" ============================================"/>
        </L7p:CommentAssertion>
        <L7p:CommentAssertion>
            <L7p:Comment stringValue=" === ***  THIS POLICY IS READ ONLY ***"/>
        </L7p:CommentAssertion>
        <L7p:CommentAssertion>
            <L7p:Comment stringValue=" === Required changes can be implemented in policies in the 'Customizations' folder "/>
        </L7p:CommentAssertion>
        <L7p:CommentAssertion>
            <L7p:Comment stringValue=" === The policies within that folder will have the same name as this policy but "/>
        </L7p:CommentAssertion>
        <L7p:CommentAssertion>
            <L7p:Comment stringValue=" === either prefixed with '#' or suffixed with 'Extensions'"/>
        </L7p:CommentAssertion>
        <L7p:CommentAssertion>
            <L7p:Comment stringValue=" === Prefixed policies can be used to overwrite variables of this policy"/>
        </L7p:CommentAssertion>
        <L7p:CommentAssertion>
            <L7p:Comment stringValue=" === Suffixed policies can be used to extend functionality"/>
        </L7p:CommentAssertion>
        <L7p:CommentAssertion>
            <L7p:Comment stringValue=" === If you find you cannot add your customizations using the policies in the 'Customizations' folder"/>
        </L7p:CommentAssertion>
        <L7p:CommentAssertion>
            <L7p:Comment stringValue=" === please contact CA APIM Support so we can improve customization capability"/>
        </L7p:CommentAssertion>
        <L7p:CommentAssertion>
            <L7p:Comment stringValue=" ============================================"/>
        </L7p:CommentAssertion>
        <L7p:CommentAssertion>
            <L7p:Comment stringValue="This policy can be found and should be used as 'Encapsulated Assertion'!"/>
        </L7p:CommentAssertion>
        <L7p:CommentAssertion>
            <L7p:Comment stringValue="This Policy validates subject_token and actor_token and generates exchange token response"/>
        </L7p:CommentAssertion>
        <L7p:CommentAssertion>
            <L7p:Comment stringValue="Before validating subject_token and actor_token, this policy verifies all the request parameters"/>
        </L7p:CommentAssertion>
        <L7p:Encapsulated>
            <L7p:EncapsulatedAssertionConfigGuid stringValue="2e6e2ef3-a36f-4548-a2c4-7b369b7ae184"/>
            <L7p:EncapsulatedAssertionConfigName stringValue="OTK Variable Configuration"/>
        </L7p:Encapsulated>
        <L7p:SetVariable>
            <L7p:Base64Expression stringValue=""/>
            <L7p:VariableToSet stringValue="act"/>
        </L7p:SetVariable>
        <L7p:SetVariable>
            <L7p:Base64Expression stringValue=""/>
            <L7p:VariableToSet stringValue="act_claim"/>
        </L7p:SetVariable>
        <L7p:SetVariable>
            <L7p:Base64Expression stringValue=""/>
            <L7p:VariableToSet stringValue="may_act_claim"/>
        </L7p:SetVariable>
        <wsp:OneOrMore wsp:Usage="Required">
            <wsp:All wsp:Usage="Required">
                <L7p:ComparisonAssertion>
                    <L7p:CaseSensitive booleanValue="false"/>
                    <L7p:Expression1 stringValue="${subject_token}"/>
                    <L7p:Expression2 stringValue=""/>
                    <L7p:Negate booleanValue="true"/>
                    <L7p:Operator operator="EMPTY"/>
                    <L7p:Predicates predicates="included">
                        <L7p:item binary="included">
                            <L7p:CaseSensitive booleanValue="false"/>
                            <L7p:Negated booleanValue="true"/>
                            <L7p:Operator operator="EMPTY"/>
                            <L7p:RightValue stringValue=""/>
                        </L7p:item>
                    </L7p:Predicates>
                </L7p:ComparisonAssertion>
                <L7p:ComparisonAssertion>
                    <L7p:Expression1 stringValue="${subject_token_type}"/>
                    <L7p:Expression2 stringValue=""/>
                    <L7p:Negate booleanValue="true"/>
                    <L7p:Operator operator="EMPTY"/>
                    <L7p:Predicates predicates="included">
                        <L7p:item binary="included">
                            <L7p:Negated booleanValue="true"/>
                            <L7p:Operator operator="EMPTY"/>
                            <L7p:RightValue stringValue=""/>
                        </L7p:item>
                    </L7p:Predicates>
                </L7p:ComparisonAssertion>
            </wsp:All>
            <wsp:All wsp:Usage="Required">
                <L7p:SetVariable>
                    <L7p:Base64Expression stringValue="MTAz"/>
                    <L7p:VariableToSet stringValue="error.code"/>
                </L7p:SetVariable>
                <L7p:FalseAssertion/>
            </wsp:All>
            <L7p:assertionComment>
                <L7p:Properties mapValue="included">
                    <L7p:entry>
                        <L7p:key stringValue="RIGHT.COMMENT"/>
                        <L7p:value stringValue="// subject_token and subject_token_type are required parameters"/>
                    </L7p:entry>
                </L7p:Properties>
            </L7p:assertionComment>
        </wsp:OneOrMore>
        <wsp:OneOrMore wsp:Usage="Required">
            <wsp:All wsp:Usage="Required">
                <L7p:ComparisonAssertion>
                    <L7p:Expression1 stringValue="${requested_token_type}"/>
                    <L7p:Expression2 stringValue="urn:ietf:params:oauth:token-type:access_token"/>
                    <L7p:Operator operator="EMPTY"/>
                    <L7p:Predicates predicates="included">
                        <L7p:item binary="included">
                            <L7p:Operator operator="EMPTY"/>
                            <L7p:RightValue stringValue="urn:ietf:params:oauth:token-type:access_token"/>
                        </L7p:item>
                    </L7p:Predicates>
                </L7p:ComparisonAssertion>
                <L7p:SetVariable>
                    <L7p:Base64Expression stringValue="dXJuOmlldGY6cGFyYW1zOm9hdXRoOnRva2VuLXR5cGU6YWNjZXNzX3Rva2Vu"/>
                    <L7p:VariableToSet stringValue="issued_token_type"/>
                </L7p:SetVariable>
            </wsp:All>
            <wsp:All wsp:Usage="Required">
                <L7p:ComparisonAssertion>
                    <L7p:CaseSensitive booleanValue="false"/>
                    <L7p:Expression1 stringValue="${requested_token_type}"/>
                    <L7p:Operator operatorNull="null"/>
                    <L7p:Predicates predicates="included">
                        <L7p:item regex="included">
                            <L7p:Pattern stringValue="urn:ietf:params:oauth:token-type:(access_token|id_token)"/>
                        </L7p:item>
                    </L7p:Predicates>
                </L7p:ComparisonAssertion>
                <L7p:SetVariable>
                    <L7p:Base64Expression stringValue="JHtyZXF1ZXN0ZWRfdG9rZW5fdHlwZX0="/>
                    <L7p:VariableToSet stringValue="issued_token_type"/>
                </L7p:SetVariable>
                <L7p:assertionComment>
                    <L7p:Properties mapValue="included">
                        <L7p:entry>
                            <L7p:key stringValue="RIGHT.COMMENT"/>
                            <L7p:value stringValue="// access_token or id_token"/>
                        </L7p:entry>
                    </L7p:Properties>
                </L7p:assertionComment>
            </wsp:All>
            <wsp:All wsp:Usage="Required">
                <L7p:SetVariable>
                    <L7p:Base64Expression stringValue="MTk1"/>
                    <L7p:VariableToSet stringValue="error.code"/>
                </L7p:SetVariable>
                <L7p:FalseAssertion/>
                <L7p:assertionComment>
                    <L7p:Properties mapValue="included">
                        <L7p:entry>
                            <L7p:key stringValue="LEFT.COMMENT"/>
                            <L7p:value stringValue="Eror"/>
                        </L7p:entry>
                    </L7p:Properties>
                </L7p:assertionComment>
            </wsp:All>
            <L7p:assertionComment>
                <L7p:Properties mapValue="included">
                    <L7p:entry>
                        <L7p:key stringValue="RIGHT.COMMENT"/>
                        <L7p:value stringValue="// validate requested_token_type"/>
                    </L7p:entry>
                </L7p:Properties>
            </L7p:assertionComment>
        </wsp:OneOrMore>
        <wsp:OneOrMore wsp:Usage="Required">
            <L7p:ComparisonAssertion>
                <L7p:CaseSensitive booleanValue="false"/>
                <L7p:Expression1 stringValue="${subject_token_type}"/>
                <L7p:Operator operatorNull="null"/>
                <L7p:Predicates predicates="included">
                    <L7p:item regex="included">
                        <L7p:Pattern stringValue="urn:ietf:params:oauth:token-type:(access_token|id_token|saml1|saml2|jwt)"/>
                    </L7p:item>
                </L7p:Predicates>
            </L7p:ComparisonAssertion>
            <wsp:All wsp:Usage="Required">
                <L7p:SetVariable>
                    <L7p:Base64Expression stringValue="MTk2"/>
                    <L7p:VariableToSet stringValue="error.code"/>
                </L7p:SetVariable>
                <L7p:FalseAssertion/>
            </wsp:All>
            <L7p:assertionComment>
                <L7p:Properties mapValue="included">
                    <L7p:entry>
                        <L7p:key stringValue="RIGHT.COMMENT"/>
                        <L7p:value stringValue="// validate subject_token_type"/>
                    </L7p:entry>
                </L7p:Properties>
            </L7p:assertionComment>
        </wsp:OneOrMore>
        <wsp:OneOrMore wsp:Usage="Required">
            <L7p:ComparisonAssertion>
                <L7p:CaseSensitive booleanValue="false"/>
                <L7p:Expression1 stringValue="${actor_token}"/>
                <L7p:Expression2 stringValue="urn:ietf:params:oauth:token-type:access_token"/>
                <L7p:Operator operator="EMPTY"/>
                <L7p:Predicates predicates="included">
                    <L7p:item binary="included">
                        <L7p:CaseSensitive booleanValue="false"/>
                        <L7p:Operator operator="EMPTY"/>
                        <L7p:RightValue stringValue="urn:ietf:params:oauth:token-type:access_token"/>
                    </L7p:item>
                </L7p:Predicates>
            </L7p:ComparisonAssertion>
            <L7p:ComparisonAssertion>
                <L7p:CaseSensitive booleanValue="false"/>
                <L7p:Expression1 stringValue="${actor_token_type}"/>
                <L7p:Operator operatorNull="null"/>
                <L7p:Predicates predicates="included">
                    <L7p:item regex="included">
                        <L7p:Pattern stringValue="urn:ietf:params:oauth:token-type:(access_token|id_token)"/>
                    </L7p:item>
                </L7p:Predicates>
            </L7p:ComparisonAssertion>
            <wsp:All wsp:Usage="Required">
                <L7p:SetVariable>
                    <L7p:Base64Expression stringValue="MTk3"/>
                    <L7p:VariableToSet stringValue="error.code"/>
                </L7p:SetVariable>
                <L7p:FalseAssertion/>
            </wsp:All>
            <L7p:assertionComment>
                <L7p:Properties mapValue="included">
                    <L7p:entry>
                        <L7p:key stringValue="RIGHT.COMMENT"/>
                        <L7p:value stringValue="// validate actor_token_type"/>
                    </L7p:entry>
                </L7p:Properties>
            </L7p:assertionComment>
        </wsp:OneOrMore>
        <wsp:OneOrMore wsp:Usage="Required">
            <wsp:All wsp:Usage="Required">
                <L7p:SetVariable>
                    <L7p:Base64Expression stringValue="JHtjbGllbnRfY3VzdG9tfQ=="/>
                    <L7p:ContentType stringValue="application/json; charset=utf-8"/>
                    <L7p:DataType variableDataType="message"/>
                    <L7p:VariableToSet stringValue="client_custom_privileged"/>
                </L7p:SetVariable>
                <L7p:EvaluateJsonPathExpressionV2>
                    <L7p:Expression stringValue="privileged"/>
                    <L7p:OtherTargetMessageVariable stringValue="client_custom_privileged"/>
                    <L7p:Target target="OTHER"/>
                    <L7p:VariablePrefix stringValue="privileged"/>
                </L7p:EvaluateJsonPathExpressionV2>
                <L7p:ComparisonAssertion>
                    <L7p:Expression1 stringValue="${privileged.result}"/>
                    <L7p:Expression2 stringValue="true"/>
                    <L7p:Predicates predicates="included">
                        <L7p:item binary="included">
                            <L7p:RightValue stringValue="true"/>
                        </L7p:item>
                    </L7p:Predicates>
                </L7p:ComparisonAssertion>
                <L7p:SetVariable>
                    <L7p:Base64Expression stringValue="dHJ1ZQ=="/>
                    <L7p:VariableToSet stringValue="is_privileged_client"/>
                </L7p:SetVariable>
            </wsp:All>
            <L7p:SetVariable>
                <L7p:Base64Expression stringValue="ZmFsc2U="/>
                <L7p:VariableToSet stringValue="is_privileged_client"/>
            </L7p:SetVariable>
            <L7p:assertionComment>
                <L7p:Properties mapValue="included">
                    <L7p:entry>
                        <L7p:key stringValue="RIGHT.COMMENT"/>
                        <L7p:value stringValue="//verify given client is privileged"/>
                    </L7p:entry>
                </L7p:Properties>
            </L7p:assertionComment>
        </wsp:OneOrMore>
        <wsp:OneOrMore wsp:Usage="Required">
            <L7p:ComparisonAssertion>
                <L7p:CaseSensitive booleanValue="false"/>
                <L7p:Expression1 stringValue="${actor_token}"/>
                <L7p:Expression2 stringValue="urn:ietf:params:oauth:token-type:access_token"/>
                <L7p:Operator operator="EMPTY"/>
                <L7p:Predicates predicates="included">
                    <L7p:item binary="included">
                        <L7p:CaseSensitive booleanValue="false"/>
                        <L7p:Operator operator="EMPTY"/>
                        <L7p:RightValue stringValue="urn:ietf:params:oauth:token-type:access_token"/>
                    </L7p:item>
                </L7p:Predicates>
            </L7p:ComparisonAssertion>
            <wsp:All wsp:Usage="Required">
                <L7p:ComparisonAssertion>
                    <L7p:Expression1 stringValue="${actor_token_type}"/>
                    <L7p:Expression2 stringValue="urn:ietf:params:oauth:token-type:access_token"/>
                    <L7p:Predicates predicates="included">
                        <L7p:item binary="included">
                            <L7p:RightValue stringValue="urn:ietf:params:oauth:token-type:access_token"/>
                        </L7p:item>
                    </L7p:Predicates>
                </L7p:ComparisonAssertion>
                <L7p:AddHeader>
                    <L7p:HeaderName stringValue="Authorization"/>
                    <L7p:HeaderValue stringValue=""/>
                    <L7p:Operation operation="REMOVE"/>
                    <L7p:RemoveExisting booleanValue="true"/>
                </L7p:AddHeader>
                <L7p:Encapsulated>
                    <L7p:EncapsulatedAssertionConfigGuid stringValue="393bcb93-82ad-4b55-8333-1119f607a560"/>
                    <L7p:EncapsulatedAssertionConfigName stringValue="OTK Require OAuth 2.0 Token"/>
                    <L7p:Parameters mapValue="included">
                        <L7p:entry>
                            <L7p:key stringValue="any_resource_required"/>
                            <L7p:value stringValue="false"/>
                        </L7p:entry>
                        <L7p:entry>
                            <L7p:key stringValue="cache_lifetime"/>
                            <L7p:value stringValue="30"/>
                        </L7p:entry>
                        <L7p:entry>
                            <L7p:key stringValue="custom"/>
                            <L7p:value stringValue=""/>
                        </L7p:entry>
                        <L7p:entry>
                            <L7p:key stringValue="disable_audience_check"/>
                            <L7p:value stringValue="true"/>
                        </L7p:entry>
                        <L7p:entry>
                            <L7p:key stringValue="disallow_query"/>
                            <L7p:value stringValue="false"/>
                        </L7p:entry>
                        <L7p:entry>
                            <L7p:key stringValue="given_access_token"/>
                            <L7p:value stringValue="${actor_token}"/>
                        </L7p:entry>
                        <L7p:entry>
                            <L7p:key stringValue="onetime"/>
                            <L7p:value stringValue="false"/>
                        </L7p:entry>
                        <L7p:entry>
                            <L7p:key stringValue="resource_required"/>
                            <L7p:value stringValue=""/>
                        </L7p:entry>
                        <L7p:entry>
                            <L7p:key stringValue="scope_fail"/>
                            <L7p:value stringValue="false"/>
                        </L7p:entry>
                        <L7p:entry>
                            <L7p:key stringValue="scope_required"/>
                            <L7p:value stringValue=""/>
                        </L7p:entry>
                    </L7p:Parameters>
                </L7p:Encapsulated>
                <L7p:SetVariable>
                    <L7p:Base64Expression stringValue="InN1YiI6IiR7c2Vzc2lvbi5zdWJzY3JpYmVyX2lkfSI="/>
                    <L7p:VariableToSet stringValue="act"/>
                </L7p:SetVariable>
                <L7p:SetVariable>
                    <L7p:Base64Expression stringValue="JHtzZXNzaW9uLnN1YnNjcmliZXJfaWR9"/>
                    <L7p:VariableToSet stringValue="act_sub"/>
                </L7p:SetVariable>
                <L7p:assertionComment>
                    <L7p:Properties mapValue="included">
                        <L7p:entry>
                            <L7p:key stringValue="RIGHT.COMMENT"/>
                            <L7p:value stringValue="//validate actor token of type access_token"/>
                        </L7p:entry>
                    </L7p:Properties>
                </L7p:assertionComment>
            </wsp:All>
            <wsp:All wsp:Usage="Required">
                <L7p:ComparisonAssertion>
                    <L7p:Expression1 stringValue="${actor_token_type}"/>
                    <L7p:Expression2 stringValue="urn:ietf:params:oauth:token-type:id_token"/>
                    <L7p:Predicates predicates="included">
                        <L7p:item binary="included">
                            <L7p:RightValue stringValue="urn:ietf:params:oauth:token-type:id_token"/>
                        </L7p:item>
                    </L7p:Predicates>
                </L7p:ComparisonAssertion>
                <L7p:Encapsulated>
                    <L7p:EncapsulatedAssertionConfigGuid stringValue="f330bc51-c1fb-44bd-a07a-93baf86adad2"/>
                    <L7p:EncapsulatedAssertionConfigName stringValue="OTK id_token Validation"/>
                    <L7p:Parameters mapValue="included">
                        <L7p:entry>
                            <L7p:key stringValue="azp"/>
                            <L7p:value stringValue=""/>
                        </L7p:entry>
                        <L7p:entry>
                            <L7p:key stringValue="check_expiration"/>
                            <L7p:value stringValue="true"/>
                        </L7p:entry>
                        <L7p:entry>
                            <L7p:key stringValue="custom"/>
                            <L7p:value stringValue=""/>
                        </L7p:entry>
                        <L7p:entry>
                            <L7p:key stringValue="jwt"/>
                            <L7p:value stringValue="${actor_token}"/>
                        </L7p:entry>
                        <L7p:entry>
                            <L7p:key stringValue="resource_owner"/>
                            <L7p:value stringValue=""/>
                        </L7p:entry>
                        <L7p:entry>
                            <L7p:key stringValue="salt"/>
                            <L7p:value stringValue=""/>
                        </L7p:entry>
                        <L7p:entry>
                            <L7p:key stringValue="shared_secret"/>
                            <L7p:value stringValue=""/>
                        </L7p:entry>
                        <L7p:entry>
                            <L7p:key stringValue="shared_secret_alg"/>
                            <L7p:value stringValue=""/>
                        </L7p:entry>
                    </L7p:Parameters>
                </L7p:Encapsulated>
                <L7p:ResponseXpathAssertion>
                    <L7p:VariablePrefix stringValue="xpathResourceOwner"/>
                    <L7p:XmlMsgSrc stringValue="resp"/>
                    <L7p:XpathExpression xpathExpressionValue="included">
                        <L7p:Expression stringValue="/ns0:validation/ns0:resource_owner/text()"/>
                        <L7p:Namespaces mapValue="included">
                            <L7p:entry>
                                <L7p:key stringValue="ns0"/>
                                <L7p:value stringValue="http://ns.l7tech.com/2012/11/otk-ovp"/>
                            </L7p:entry>
                            <L7p:entry>
                                <L7p:key stringValue="s"/>
                                <L7p:value stringValue="http://schemas.xmlsoap.org/soap/envelope/"/>
                            </L7p:entry>
                            <L7p:entry>
                                <L7p:key stringValue="ns"/>
                                <L7p:value stringValue="http://ns.l7tech.com/2012/11/otk-tokenstore"/>
                            </L7p:entry>
                        </L7p:Namespaces>
                        <L7p:XpathVersion xpathVersion="XPATH_1_0"/>
                    </L7p:XpathExpression>
                </L7p:ResponseXpathAssertion>
                <L7p:SetVariable>
                    <L7p:Base64Expression stringValue="InN1YiIgOiAiJHt4cGF0aFJlc291cmNlT3duZXIucmVzdWx0fSI="/>
                    <L7p:VariableToSet stringValue="act"/>
                </L7p:SetVariable>
                <L7p:SetVariable>
                    <L7p:Base64Expression stringValue="JHt4cGF0aFJlc291cmNlT3duZXIucmVzdWx0fQ=="/>
                    <L7p:VariableToSet stringValue="act_sub"/>
                </L7p:SetVariable>
                <L7p:assertionComment>
                    <L7p:Properties mapValue="included">
                        <L7p:entry>
                            <L7p:key stringValue="RIGHT.COMMENT"/>
                            <L7p:value stringValue="// validate actor token of type id_token"/>
                        </L7p:entry>
                    </L7p:Properties>
                </L7p:assertionComment>
            </wsp:All>
            <L7p:assertionComment>
                <L7p:Properties mapValue="included">
                    <L7p:entry>
                        <L7p:key stringValue="RIGHT.COMMENT"/>
                        <L7p:value stringValue="// validate actor token"/>
                    </L7p:entry>
                </L7p:Properties>
            </L7p:assertionComment>
        </wsp:OneOrMore>
        <wsp:OneOrMore wsp:Usage="Required">
            <wsp:All wsp:Usage="Required">
                <L7p:ComparisonAssertion>
                    <L7p:Expression1 stringValue="${subject_token_type}"/>
                    <L7p:Expression2 stringValue="urn:ietf:params:oauth:token-type:access_token"/>
                    <L7p:Predicates predicates="included">
                        <L7p:item binary="included">
                            <L7p:RightValue stringValue="urn:ietf:params:oauth:token-type:access_token"/>
                        </L7p:item>
                    </L7p:Predicates>
                </L7p:ComparisonAssertion>
                <L7p:Include>
                    <L7p:PolicyGuid stringValue="2cc01234-f3dc-447a-94a2-bcb11454a149"/>
                    <L7p:PolicyName stringValue="#OTK Validate Subject Token (access_token)"/>
                </L7p:Include>
                <L7p:assertionComment>
                    <L7p:Properties mapValue="included">
                        <L7p:entry>
                            <L7p:key stringValue="RIGHT.COMMENT"/>
                            <L7p:value stringValue="// validate subject token of type access_token"/>
                        </L7p:entry>
                    </L7p:Properties>
                </L7p:assertionComment>
            </wsp:All>
            <wsp:All wsp:Usage="Required">
                <L7p:ComparisonAssertion>
                    <L7p:Expression1 stringValue="${subject_token_type}"/>
                    <L7p:Expression2 stringValue="urn:ietf:params:oauth:token-type:id_token"/>
                    <L7p:Predicates predicates="included">
                        <L7p:item binary="included">
                            <L7p:RightValue stringValue="urn:ietf:params:oauth:token-type:id_token"/>
                        </L7p:item>
                    </L7p:Predicates>
                </L7p:ComparisonAssertion>
                <L7p:Include>
                    <L7p:PolicyGuid stringValue="335d907a-8c68-4f46-b146-1298929dd738"/>
                    <L7p:PolicyName stringValue="#OTK Validate Subject Token (id_token)"/>
                </L7p:Include>
                <L7p:assertionComment>
                    <L7p:Properties mapValue="included">
                        <L7p:entry>
                            <L7p:key stringValue="RIGHT.COMMENT"/>
                            <L7p:value stringValue="// validate subject token of type id_token"/>
                        </L7p:entry>
                    </L7p:Properties>
                </L7p:assertionComment>
            </wsp:All>
            <wsp:All wsp:Usage="Required">
                <L7p:ComparisonAssertion>
                    <L7p:Expression1 stringValue="${subject_token_type}"/>
                    <L7p:Expression2 stringValue="urn:ietf:params:oauth:token-type:saml2"/>
                    <L7p:Predicates predicates="included">
                        <L7p:item binary="included">
                            <L7p:RightValue stringValue="urn:ietf:params:oauth:token-type:saml2"/>
                        </L7p:item>
                    </L7p:Predicates>
                </L7p:ComparisonAssertion>
                <L7p:EncodeDecode>
                    <L7p:CharacterEncoding stringValueNull="null"/>
                    <L7p:SourceVariableName stringValue="subject_token"/>
                    <L7p:TargetContentType stringValue="text/xml;charset=UTF-8"/>
                    <L7p:TargetDataType variableDataType="message"/>
                    <L7p:TargetVariableName stringValue="bearerToken"/>
                    <L7p:TransformType transformType="BASE64_DECODE"/>
                </L7p:EncodeDecode>
                <L7p:Include>
                    <L7p:PolicyGuid stringValue="e8c7f796-1a4e-451e-8f82-f9e8edbb0723"/>
                    <L7p:PolicyName stringValue="#OTK Validate SAML Token v2"/>
                </L7p:Include>
                <L7p:assertionComment>
                    <L7p:Properties mapValue="included">
                        <L7p:entry>
                            <L7p:key stringValue="RIGHT.COMMENT"/>
                            <L7p:value stringValue="//validate subject token of type saml2"/>
                        </L7p:entry>
                    </L7p:Properties>
                </L7p:assertionComment>
            </wsp:All>
            <wsp:All wsp:Usage="Required">
                <L7p:ComparisonAssertion>
                    <L7p:Expression1 stringValue="${subject_token_type}"/>
                    <L7p:Expression2 stringValue="urn:ietf:params:oauth:token-type:saml1"/>
                    <L7p:Predicates predicates="included">
                        <L7p:item binary="included">
                            <L7p:RightValue stringValue="urn:ietf:params:oauth:token-type:saml1"/>
                        </L7p:item>
                    </L7p:Predicates>
                </L7p:ComparisonAssertion>
                <L7p:EncodeDecode>
                    <L7p:CharacterEncoding stringValueNull="null"/>
                    <L7p:SourceVariableName stringValue="subject_token"/>
                    <L7p:TargetContentType stringValue="text/xml;charset=UTF-8"/>
                    <L7p:TargetDataType variableDataType="message"/>
                    <L7p:TargetVariableName stringValue="bearerToken"/>
                    <L7p:TransformType transformType="BASE64_DECODE"/>
                </L7p:EncodeDecode>
                <L7p:Include>
                    <L7p:PolicyGuid stringValue="992c95a1-c4d4-47e1-9097-5707f4aa595e"/>
                    <L7p:PolicyName stringValue="#OTK Validate SAML Token v1"/>
                </L7p:Include>
                <L7p:assertionComment>
                    <L7p:Properties mapValue="included">
                        <L7p:entry>
                            <L7p:key stringValue="RIGHT.COMMENT"/>
                            <L7p:value stringValue="// validate subject token of type saml1"/>
                        </L7p:entry>
                    </L7p:Properties>
                </L7p:assertionComment>
            </wsp:All>
            <wsp:All wsp:Usage="Required">
                <L7p:ComparisonAssertion>
                    <L7p:Expression1 stringValue="${subject_token_type}"/>
                    <L7p:Expression2 stringValue="urn:ietf:params:oauth:token-type:jwt"/>
                    <L7p:Predicates predicates="included">
                        <L7p:item binary="included">
                            <L7p:RightValue stringValue="urn:ietf:params:oauth:token-type:jwt"/>
                        </L7p:item>
                    </L7p:Predicates>
                </L7p:ComparisonAssertion>
                <L7p:Encapsulated>
                    <L7p:EncapsulatedAssertionConfigGuid stringValue="3a383b6b-f60d-4d1b-a08d-26ea81c539a7"/>
                    <L7p:EncapsulatedAssertionConfigName stringValue="OTK Inspect JWT"/>
                    <L7p:Parameters mapValue="included">
                        <L7p:entry>
                            <L7p:key stringValue="check_expiry"/>
                            <L7p:value stringValue=""/>
                        </L7p:entry>
                        <L7p:entry>
                            <L7p:key stringValue="jwks"/>
                            <L7p:value stringValue=""/>
                        </L7p:entry>
                        <L7p:entry>
                            <L7p:key stringValue="jwt"/>
                            <L7p:value stringValue="${subject_token}"/>
                        </L7p:entry>
                        <L7p:entry>
                            <L7p:key stringValue="jwt_hint"/>
                            <L7p:value stringValue="token_exchange_subject_token"/>
                        </L7p:entry>
                        <L7p:entry>
                            <L7p:key stringValue="kid"/>
                            <L7p:value stringValue=""/>
                        </L7p:entry>
                    </L7p:Parameters>
                </L7p:Encapsulated>
                <L7p:ComparisonAssertion>
                    <L7p:Expression1 stringValue="${jwt_payload}"/>
                    <L7p:Expression2 stringValue=""/>
                    <L7p:Negate booleanValue="true"/>
                    <L7p:Operator operator="EMPTY"/>
                    <L7p:Predicates predicates="included">
                        <L7p:item binary="included">
                            <L7p:Negated booleanValue="true"/>
                            <L7p:Operator operator="EMPTY"/>
                            <L7p:RightValue stringValue=""/>
                        </L7p:item>
                    </L7p:Predicates>
                </L7p:ComparisonAssertion>
                <L7p:ComparisonAssertion>
                    <L7p:Expression1 stringValue="${jwt_header}"/>
                    <L7p:Expression2 stringValue=""/>
                    <L7p:Negate booleanValue="true"/>
                    <L7p:Operator operator="EMPTY"/>
                    <L7p:Predicates predicates="included">
                        <L7p:item binary="included">
                            <L7p:Negated booleanValue="true"/>
                            <L7p:Operator operator="EMPTY"/>
                            <L7p:RightValue stringValue=""/>
                        </L7p:item>
                    </L7p:Predicates>
                </L7p:ComparisonAssertion>
                <L7p:SetVariable>
                    <L7p:Base64Expression stringValue="JHtqd3RfcGF5bG9hZH0="/>
                    <L7p:ContentType stringValue="application/json; charset=utf-8"/>
                    <L7p:DataType variableDataType="message"/>
                    <L7p:VariableToSet stringValue="jwt_payload"/>
                </L7p:SetVariable>
                <L7p:SetVariable>
                    <L7p:Base64Expression stringValue="JHtqd3RfaGVhZGVyfQ=="/>
                    <L7p:ContentType stringValue="application/json; charset=utf-8"/>
                    <L7p:DataType variableDataType="message"/>
                    <L7p:VariableToSet stringValue="jwt_header"/>
                </L7p:SetVariable>
                <L7p:EvaluateJsonPathExpressionV2>
                    <L7p:Expression stringValue="$.iss"/>
                    <L7p:OtherTargetMessageVariable stringValue="jwt_payload"/>
                    <L7p:Target target="OTHER"/>
                    <L7p:VariablePrefix stringValue="jwt_iss_path"/>
                </L7p:EvaluateJsonPathExpressionV2>
                <L7p:EvaluateJsonPathExpressionV2>
                    <L7p:Expression stringValue="$.kid"/>
                    <L7p:OtherTargetMessageVariable stringValue="jwt_header"/>
                    <L7p:Target target="OTHER"/>
                    <L7p:VariablePrefix stringValue="jwt_kid_path"/>
                </L7p:EvaluateJsonPathExpressionV2>
                <L7p:EvaluateJsonPathExpressionV2>
                    <L7p:Expression stringValue="$.sub"/>
                    <L7p:OtherTargetMessageVariable stringValue="jwt_payload"/>
                    <L7p:Target target="OTHER"/>
                    <L7p:VariablePrefix stringValue="jwt_sub_path"/>
                </L7p:EvaluateJsonPathExpressionV2>
                <L7p:SetVariable>
                    <L7p:Base64Expression stringValue="JHtqd3Rfc3ViX3BhdGgucmVzdWx0fQ=="/>
                    <L7p:VariableToSet stringValue="owner"/>
                </L7p:SetVariable>
                <L7p:Encapsulated>
                    <L7p:EncapsulatedAssertionConfigGuid stringValue="70c75780-8758-4450-8d96-506441369e07"/>
                    <L7p:EncapsulatedAssertionConfigName stringValue="OTK Get JWKS"/>
                    <L7p:Parameters mapValue="included">
                        <L7p:entry>
                            <L7p:key stringValue="cache_lifetime"/>
                            <L7p:value stringValue="3600"/>
                        </L7p:entry>
                        <L7p:entry>
                            <L7p:key stringValue="issuer"/>
                            <L7p:value stringValue="${jwt_iss_path.result}"/>
                        </L7p:entry>
                        <L7p:entry>
                            <L7p:key stringValue="jwks_url"/>
                            <L7p:value stringValue=""/>
                        </L7p:entry>
                    </L7p:Parameters>
                </L7p:Encapsulated>
                <L7p:Encapsulated>
                    <L7p:EncapsulatedAssertionConfigGuid stringValue="3a383b6b-f60d-4d1b-a08d-26ea81c539a7"/>
                    <L7p:EncapsulatedAssertionConfigName stringValue="OTK Inspect JWT"/>
                    <L7p:Parameters mapValue="included">
                        <L7p:entry>
                            <L7p:key stringValue="check_expiry"/>
                            <L7p:value stringValue="true"/>
                        </L7p:entry>
                        <L7p:entry>
                            <L7p:key stringValue="jwks"/>
                            <L7p:value stringValue="${jwks}"/>
                        </L7p:entry>
                        <L7p:entry>
                            <L7p:key stringValue="jwt"/>
                            <L7p:value stringValue="${subject_token}"/>
                        </L7p:entry>
                        <L7p:entry>
                            <L7p:key stringValue="jwt_hint"/>
                            <L7p:value stringValue="token_exchange_subject_token"/>
                        </L7p:entry>
                        <L7p:entry>
                            <L7p:key stringValue="kid"/>
                            <L7p:value stringValue="${jwt_kid_path.result}"/>
                        </L7p:entry>
                    </L7p:Parameters>
                </L7p:Encapsulated>
                <wsp:OneOrMore wsp:Usage="Required">
                    <wsp:All wsp:Usage="Required">
                        <L7p:SetVariable>
                            <L7p:Base64Expression stringValue="JHtqd3RfcGF5bG9hZH0="/>
                            <L7p:ContentType stringValue="application/json; charset=utf-8"/>
                            <L7p:DataType variableDataType="message"/>
                            <L7p:VariableToSet stringValue="jwt_payload_json"/>
                        </L7p:SetVariable>
                        <L7p:EvaluateJsonPathExpressionV2>
                            <L7p:Expression stringValue="may_act"/>
                            <L7p:OtherTargetMessageVariable stringValue="jwt_payload_json"/>
                            <L7p:Target target="OTHER"/>
                            <L7p:VariablePrefix stringValue="jwt_may_act_claim"/>
                        </L7p:EvaluateJsonPathExpressionV2>
                        <L7p:SetVariable>
                            <L7p:Base64Expression stringValue="JHtqd3RfbWF5X2FjdF9jbGFpbS5yZXN1bHR9"/>
                            <L7p:VariableToSet stringValue="may_act_claim"/>
                        </L7p:SetVariable>
                    </wsp:All>
                    <L7p:SetVariable>
                        <L7p:Base64Expression stringValue=""/>
                        <L7p:VariableToSet stringValue="may_act_claim"/>
                    </L7p:SetVariable>
                </wsp:OneOrMore>
                <L7p:assertionComment>
                    <L7p:Properties mapValue="included">
                        <L7p:entry>
                            <L7p:key stringValue="RIGHT.COMMENT"/>
                            <L7p:value stringValue="// validate subject token of type jwt"/>
                        </L7p:entry>
                    </L7p:Properties>
                </L7p:assertionComment>
            </wsp:All>
            <L7p:Encapsulated>
                <L7p:EncapsulatedAssertionConfigGuid stringValue="56bd8147-3ab4-4d09-9460-8b2de02b7a9e"/>
                <L7p:EncapsulatedAssertionConfigName stringValue="OTK Fail with error message"/>
                <L7p:Parameters mapValue="included">
                    <L7p:entry>
                        <L7p:key stringValue="apiPrefix"/>
                        <L7p:value stringValue=""/>
                    </L7p:entry>
                    <L7p:entry>
                        <L7p:key stringValue="custom"/>
                        <L7p:value stringValue=""/>
                    </L7p:entry>
                    <L7p:entry>
                        <L7p:key stringValue="givenErrorCode"/>
                        <L7p:value stringValue="198"/>
                    </L7p:entry>
                </L7p:Parameters>
            </L7p:Encapsulated>
            <L7p:assertionComment>
                <L7p:Properties mapValue="included">
                    <L7p:entry>
                        <L7p:key stringValue="RIGHT.COMMENT"/>
                        <L7p:value stringValue="// validate subject token"/>
                    </L7p:entry>
                </L7p:Properties>
            </L7p:assertionComment>
        </wsp:OneOrMore>
        <wsp:OneOrMore wsp:Usage="Required">
            <L7p:ComparisonAssertion>
                <L7p:Expression1 stringValue="${act}"/>
                <L7p:Expression2 stringValue=""/>
                <L7p:Operator operator="EMPTY"/>
                <L7p:Predicates predicates="included">
                    <L7p:item binary="included">
                        <L7p:Operator operator="EMPTY"/>
                        <L7p:RightValue stringValue=""/>
                    </L7p:item>
                </L7p:Predicates>
            </L7p:ComparisonAssertion>
            <L7p:ComparisonAssertion>
                <L7p:Expression1 stringValue="${may_act_claim}"/>
                <L7p:Expression2 stringValue=""/>
                <L7p:Operator operator="EMPTY"/>
                <L7p:Predicates predicates="included">
                    <L7p:item binary="included">
                        <L7p:Operator operator="EMPTY"/>
                        <L7p:RightValue stringValue=""/>
                    </L7p:item>
                </L7p:Predicates>
            </L7p:ComparisonAssertion>
            <wsp:OneOrMore wsp:Usage="Required">
                <wsp:All wsp:Usage="Required">
                    <L7p:SetVariable>
                        <L7p:Base64Expression stringValue="JHttYXlfYWN0X2NsYWltfQ=="/>
                        <L7p:ContentType stringValue="application/json; charset=utf-8"/>
                        <L7p:DataType variableDataType="message"/>
                        <L7p:VariableToSet stringValue="may_act_claim_json"/>
                    </L7p:SetVariable>
                    <L7p:EvaluateJsonPathExpressionV2>
                        <L7p:Expression stringValue="$..[?(@.sub=='${act_sub}')]"/>
                        <L7p:OtherTargetMessageVariable stringValue="may_act_claim_json"/>
                        <L7p:Target target="OTHER"/>
                    </L7p:EvaluateJsonPathExpressionV2>
                </wsp:All>
                <wsp:All wsp:Usage="Required">
                    <L7p:SetVariable>
                        <L7p:Base64Expression stringValue="MTk5"/>
                        <L7p:VariableToSet stringValue="error.code"/>
                    </L7p:SetVariable>
                    <L7p:FalseAssertion/>
                </wsp:All>
            </wsp:OneOrMore>
            <L7p:assertionComment>
                <L7p:Properties mapValue="included">
                    <L7p:entry>
                        <L7p:key stringValue="RIGHT.COMMENT"/>
                        <L7p:value stringValue="// validate may_act claim"/>
                    </L7p:entry>
                </L7p:Properties>
            </L7p:assertionComment>
        </wsp:OneOrMore>
        <wsp:OneOrMore wsp:Usage="Required">
            <L7p:ComparisonAssertion>
                <L7p:Expression1 stringValue="${act}"/>
                <L7p:Expression2 stringValue=""/>
                <L7p:Operator operator="EMPTY"/>
                <L7p:Predicates predicates="included">
                    <L7p:item binary="included">
                        <L7p:Operator operator="EMPTY"/>
                        <L7p:RightValue stringValue=""/>
                    </L7p:item>
                </L7p:Predicates>
            </L7p:ComparisonAssertion>
            <L7p:ComparisonAssertion>
                <L7p:Expression1 stringValue="${act_claim}"/>
                <L7p:Expression2 stringValue=""/>
                <L7p:Operator operator="EMPTY"/>
                <L7p:Predicates predicates="included">
                    <L7p:item binary="included">
                        <L7p:Operator operator="EMPTY"/>
                        <L7p:RightValue stringValue=""/>
                    </L7p:item>
                </L7p:Predicates>
            </L7p:ComparisonAssertion>
            <L7p:SetVariable>
                <L7p:Base64Expression stringValue="JHthY3R9LA0KImFjdCI6ICR7YWN0X2NsYWltfQ=="/>
                <L7p:VariableToSet stringValue="act"/>
            </L7p:SetVariable>
            <L7p:assertionComment>
                <L7p:Properties mapValue="included">
                    <L7p:entry>
                        <L7p:key stringValue="RIGHT.COMMENT"/>
                        <L7p:value stringValue="// add nested act claim if present"/>
                    </L7p:entry>
                </L7p:Properties>
            </L7p:assertionComment>
        </wsp:OneOrMore>
        <L7p:Include>
            <L7p:PolicyGuid stringValue="54ba189d-900a-4869-bd4c-4e9ef8432202"/>
            <L7p:PolicyName stringValue="#OTK Exchange Token Lifetime Configuration"/>
        </L7p:Include>
        <wsp:OneOrMore wsp:Usage="Required">
            <L7p:ComparisonAssertion>
                <L7p:Expression1 stringValue="${act}"/>
                <L7p:Expression2 stringValue=""/>
                <L7p:Operator operator="EMPTY"/>
                <L7p:Predicates predicates="included">
                    <L7p:item binary="included">
                        <L7p:Operator operator="EMPTY"/>
                        <L7p:RightValue stringValue=""/>
                    </L7p:item>
                </L7p:Predicates>
            </L7p:ComparisonAssertion>
            <wsp:All wsp:Usage="Required">
                <L7p:Regex>
                    <L7p:AutoTarget booleanValue="false"/>
                    <L7p:CaptureVar stringValue="jsonSession"/>
                    <L7p:OtherTargetMessageVariable stringValue="session_output"/>
                    <L7p:Regex stringValue="[{](.*)"/>
                    <L7p:Replacement stringValue=""/>
                    <L7p:Target target="OTHER"/>
                </L7p:Regex>
                <L7p:SetVariable>
                    <L7p:Base64Expression stringValue="ew0KICAgICJhY3QiOiB7JHthY3R9fSwke2pzb25TZXNzaW9uWzFdfQ=="/>
                    <L7p:VariableToSet stringValue="session_output"/>
                </L7p:SetVariable>
            </wsp:All>
            <L7p:assertionComment>
                <L7p:Properties mapValue="included">
                    <L7p:entry>
                        <L7p:key stringValue="RIGHT.COMMENT"/>
                        <L7p:value stringValue="// add act in the session"/>
                    </L7p:entry>
                </L7p:Properties>
            </L7p:assertionComment>
        </wsp:OneOrMore>
        <L7p:Include>
            <L7p:PolicyGuid stringValue="b442591b-bafe-4be6-889e-75da1a3ca46f"/>
            <L7p:PolicyName stringValue="#OTK Validate Token Exchange Audience And Scope"/>
        </L7p:Include>
        <L7p:SetVariable>
            <L7p:Base64Expression stringValue="ew0KICAiYWNjZXNzX3Rva2VuIjoiJHthdF90b2tlbn0iLA0KICAidG9rZW5fdHlwZSI6IkJlYXJlciIsDQogICJleHBpcmVzX2luIjoke2F0X2xpZmV0aW1lfSwNCiAgInJlZnJlc2hfdG9rZW4iOiIke3J0b2tlbn0iLA0KICAiaXNzdWVkX3Rva2VuX3R5cGUiOiIke2lzc3VlZF90b2tlbl90eXBlfSIsDQogICJzY29wZSI6IiR7c2NvcGUuZ3JhbnRlZH0iDQp9"/>
            <L7p:VariableToSet stringValue="clientResponse"/>
        </L7p:SetVariable>
        <L7p:SetVariable>
            <L7p:Base64Expression stringValue=""/>
            <L7p:VariableToSet stringValue="token_secret"/>
        </L7p:SetVariable>
    </wsp:All>
</wsp:Policy>
