<?xml version="1.0" encoding="UTF-8"?>
<wsp:Policy xmlns:L7p="http://www.layer7tech.com/ws/policy" xmlns:wsp="http://schemas.xmlsoap.org/ws/2002/12/policy">
    <wsp:All wsp:Usage="Required">
        <L7p:CommentAssertion>
            <L7p:Comment stringValue=" ============================================"/>
        </L7p:CommentAssertion>
        <L7p:CommentAssertion>
            <L7p:Comment stringValue=" === ***  THIS POLICY IS READ ONLY ***"/>
        </L7p:CommentAssertion>
        <L7p:CommentAssertion>
            <L7p:Comment stringValue=" === If you have the need to customize this policy"/>
        </L7p:CommentAssertion>
        <L7p:CommentAssertion>
            <L7p:Comment stringValue=" === please contact CA APIM Support so we can improve customization capability"/>
        </L7p:CommentAssertion>
        <L7p:CommentAssertion>
            <L7p:Comment stringValue=" ============================================"/>
        </L7p:CommentAssertion>
        <L7p:CommentAssertion>
            <L7p:Comment stringValue="This policies adds an API Key, an OAuth client_id (copy of API Key) and an OAuth CLient ID as 'master-key' as used with MAG SDK"/>
        </L7p:CommentAssertion>
        <L7p:SetVariable>
            <L7p:Base64Expression stringValue=""/>
            <L7p:DataType variableDataType="dateTime"/>
            <L7p:DateOffsetExpression stringValue=""/>
            <L7p:VariableToSet stringValue="now"/>
        </L7p:SetVariable>
        <L7p:SetVariable>
            <L7p:Base64Expression stringValue="YXBwbGljYXRpb24vanNvbjtjaGFyc2V0PVVURi04"/>
            <L7p:VariableToSet stringValue="content-type"/>
        </L7p:SetVariable>
        <L7p:SetVariable>
            <L7p:Base64Expression stringValue="ewoJInBvcnRhbF9zeW5jIjogewoJCSJzeW5jVHlwZSI6IiIsCgkJImRlbGV0ZWRJZHNFcnJvciI6IFtdLAoJCSJuZXdPclVwZGF0ZWRFbnRpdGllc0Vycm9yIjogW10KCX0KfQ=="/>
            <L7p:VariableToSet stringValue="resp"/>
        </L7p:SetVariable>
        <L7p:SetVariable>
            <L7p:AssertionComment assertionComment="included">
                <L7p:Properties mapValue="included">
                    <L7p:entry>
                        <L7p:key stringValue="LEFT.COMMENT"/>
                        <L7p:value stringValue="initialize"/>
                    </L7p:entry>
                    <L7p:entry>
                        <L7p:key stringValue="RIGHT.COMMENT"/>
                        <L7p:value stringValue="will be overwritten in the case of an error"/>
                    </L7p:entry>
                </L7p:Properties>
            </L7p:AssertionComment>
            <L7p:Base64Expression stringValue=""/>
            <L7p:VariableToSet stringValue="error.code"/>
        </L7p:SetVariable>
        <L7p:CommentAssertion>
            <L7p:Comment stringValue="=== DELETE"/>
        </L7p:CommentAssertion>
        <wsp:OneOrMore wsp:Usage="Required">
            <L7p:EvaluateJsonPathExpression>
                <L7p:Expression stringValue="deletedIds"/>
                <L7p:OtherTargetMessageVariable stringValue="incomingJson"/>
                <L7p:Target target="OTHER"/>
                <L7p:VariablePrefix stringValue="apikey_elements"/>
            </L7p:EvaluateJsonPathExpression>
            <wsp:All wsp:Usage="Required">
                <L7p:SetVariable>
                    <L7p:Base64Expression stringValue=""/>
                    <L7p:VariableToSet stringValue="apikey_elements.result"/>
                </L7p:SetVariable>
                <L7p:Split>
                    <L7p:IgnoreEmptyValues booleanValue="true"/>
                    <L7p:InputVariable stringValue="apikey_elements.result"/>
                    <L7p:OutputVariable stringValue="apikey_elements.results"/>
                </L7p:Split>
            </wsp:All>
            <L7p:assertionComment>
                <L7p:Properties mapValue="included">
                    <L7p:entry>
                        <L7p:key stringValue="LEFT.COMMENT"/>
                        <L7p:value stringValue="check"/>
                    </L7p:entry>
                    <L7p:entry>
                        <L7p:key stringValue="RIGHT.COMMENT"/>
                        <L7p:value stringValue="Check if any api keys were provided to be deleted"/>
                    </L7p:entry>
                </L7p:Properties>
            </L7p:assertionComment>
        </wsp:OneOrMore>
        <wsp:OneOrMore wsp:Usage="Required">
            <L7p:ComparisonAssertion>
                <L7p:CaseSensitive booleanValue="false"/>
                <L7p:Expression1 stringValue="${apikey_elements.count}"/>
                <L7p:Operator operatorNull="null"/>
                <L7p:Predicates predicates="included">
                    <L7p:item dataType="included">
                        <L7p:Type variableDataType="int"/>
                    </L7p:item>
                    <L7p:item binary="included">
                        <L7p:CaseSensitive booleanValue="false"/>
                        <L7p:RightValue stringValue="0"/>
                    </L7p:item>
                </L7p:Predicates>
            </L7p:ComparisonAssertion>
            <L7p:ForEachLoop L7p:Usage="Required"
                loopVariable="apikey_elements.results" variablePrefix="nextApiKey">
                <wsp:OneOrMore wsp:Usage="Required">
                    <wsp:All wsp:Usage="Required">
                        <L7p:SetVariable>
                            <L7p:AssertionComment assertionComment="included">
                                <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="LEFT.COMMENT"/>
                                    <L7p:value stringValue="initialize"/>
                                    </L7p:entry>
                                    <L7p:entry>
                                    <L7p:key stringValue="RIGHT.COMMENT"/>
                                    <L7p:value stringValue="//list of apikey#apiId for portal api key cache delete "/>
                                    </L7p:entry>
                                </L7p:Properties>
                            </L7p:AssertionComment>
                            <L7p:Base64Expression stringValue=""/>
                            <L7p:VariableToSet stringValue="idlist"/>
                        </L7p:SetVariable>
                        <wsp:OneOrMore wsp:Usage="Required">
                            <wsp:All wsp:Usage="Required">
                                <L7p:JdbcQuery>
                                    <L7p:AssertionComment assertionComment="included">
                                    <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="RIGHT.COMMENT"/>
                                    <L7p:value stringValue="// query apikey and apis for cache delete, if not found fail the assertion"/>
                                    </L7p:entry>
                                    </L7p:Properties>
                                    </L7p:AssertionComment>
                                    <L7p:ConnectionName stringValue="OAuth"/>
                                    <L7p:ConvertVariablesToStrings booleanValue="false"/>
                                    <L7p:NamingMap mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="apikey"/>
                                    <L7p:value stringValue="apikey"/>
                                    </L7p:entry>
                                    <L7p:entry>
                                    <L7p:key stringValue="apis"/>
                                    <L7p:value stringValue="apis"/>
                                    </L7p:entry>
                                    </L7p:NamingMap>
                                    <L7p:SqlQuery stringValue="SELECT apikey, apis FROM portal_apikey WHERE apikey_pk = ${nextApiKey.current}"/>
                                    <L7p:VariablePrefix stringValue="apiKeyRecord"/>
                                </L7p:JdbcQuery>
                                <L7p:SetVariable>
                                    <L7p:Base64Expression stringValue="JHthcGlLZXlSZWNvcmQuYXBpc30="/>
                                    <L7p:VariableToSet stringValue="apiIdList"/>
                                </L7p:SetVariable>
                                <L7p:Split>
                                    <L7p:AssertionComment assertionComment="included">
                                    <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="RIGHT.COMMENT"/>
                                    <L7p:value stringValue="// get all api id from database for this apikey"/>
                                    </L7p:entry>
                                    </L7p:Properties>
                                    </L7p:AssertionComment>
                                    <L7p:IgnoreEmptyValues booleanValue="true"/>
                                    <L7p:InputVariable stringValue="apiIdList"/>
                                    <L7p:OutputVariable stringValue="api_ids"/>
                                </L7p:Split>
                                <L7p:ForEachLoop L7p:Usage="Required"
                                    loopVariable="api_ids" variablePrefix="nextApi_id">
                                    <L7p:SetVariable>
                                    <L7p:Base64Expression stringValue="JHtpZGxpc3R9LCR7YXBpS2V5UmVjb3JkLmFwaWtleX0jJHtuZXh0QXBpX2lkLmN1cnJlbnR9"/>
                                    <L7p:VariableToSet stringValue="idlist"/>
                                    </L7p:SetVariable>
                                </L7p:ForEachLoop>
                                <L7p:Regex>
                                    <L7p:AssertionComment assertionComment="included">
                                    <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="RIGHT.COMMENT"/>
                                    <L7p:value stringValue="// remove the leading comma"/>
                                    </L7p:entry>
                                    </L7p:Properties>
                                    </L7p:AssertionComment>
                                    <L7p:AutoTarget booleanValue="false"/>
                                    <L7p:FindAll booleanValue="true"/>
                                    <L7p:OtherTargetMessageVariable stringValue="idlist"/>
                                    <L7p:Regex stringValue="\s|^,"/>
                                    <L7p:Replace booleanValue="true"/>
                                    <L7p:Replacement stringValue=""/>
                                    <L7p:Target target="OTHER"/>
                                </L7p:Regex>
                            </wsp:All>
                            <L7p:TrueAssertion/>
                            <L7p:assertionComment>
                                <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="RIGHT.COMMENT"/>
                                    <L7p:value stringValue="//prepare list for cache delete, continue with the major process if fail"/>
                                    </L7p:entry>
                                </L7p:Properties>
                            </L7p:assertionComment>
                        </wsp:OneOrMore>
                        <L7p:Transaction L7p:Usage="Required">
                            <L7p:JdbcQuery>
                                <L7p:AssertionComment assertionComment="included">
                                    <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="RIGHT.COMMENT"/>
                                    <L7p:value stringValue="// delete oauth client"/>
                                    </L7p:entry>
                                    </L7p:Properties>
                                </L7p:AssertionComment>
                                <L7p:AssertionFailureEnabled booleanValue="false"/>
                                <L7p:ConnectionName stringValue="OAuth"/>
                                <L7p:ConvertVariablesToStrings booleanValue="false"/>
                                <L7p:SqlQuery stringValue="DELETE FROM oauth_client WHERE client_ident = ${nextApiKey.current}"/>
                            </L7p:JdbcQuery>
                            <L7p:JdbcQuery>
                                <L7p:AssertionComment assertionComment="included">
                                    <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="RIGHT.COMMENT"/>
                                    <L7p:value stringValue="// delete oauth client_id (takes effect only if foreign key on oauth_client_key - oauth_client has been deactivated)"/>
                                    </L7p:entry>
                                    </L7p:Properties>
                                </L7p:AssertionComment>
                                <L7p:AssertionFailureEnabled booleanValue="false"/>
                                <L7p:ConnectionName stringValue="OAuth"/>
                                <L7p:ConvertVariablesToStrings booleanValue="false"/>
                                <L7p:SqlQuery stringValue="DELETE FROM oauth_client_key WHERE client_ident = ${nextApiKey.current}"/>
                            </L7p:JdbcQuery>
                            <L7p:JdbcQuery>
                                <L7p:AssertionComment assertionComment="included">
                                    <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="RIGHT.COMMENT"/>
                                    <L7p:value stringValue="// delete portal apikey"/>
                                    </L7p:entry>
                                    </L7p:Properties>
                                </L7p:AssertionComment>
                                <L7p:AssertionFailureEnabled booleanValue="false"/>
                                <L7p:ConnectionName stringValue="OAuth"/>
                                <L7p:ConvertVariablesToStrings booleanValue="false"/>
                                <L7p:SqlQuery stringValue="DELETE FROM portal_apikey WHERE apikey_pk = ${nextApiKey.current}"/>
                            </L7p:JdbcQuery>
                        </L7p:Transaction>
                        <wsp:OneOrMore wsp:Usage="Required">
                            <L7p:Encapsulated>
                                <L7p:AssertionComment assertionComment="included">
                                    <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="RIGHT.COMMENT"/>
                                    <L7p:value stringValue="// delete cached api key based on idlist"/>
                                    </L7p:entry>
                                    </L7p:Properties>
                                </L7p:AssertionComment>
                                <L7p:EncapsulatedAssertionConfigGuid stringValue="fad87697-323e-4242-9231-a6bd2b3ec469"/>
                                <L7p:EncapsulatedAssertionConfigName stringValue="Portal API Key Record Cache Delete"/>
                            </L7p:Encapsulated>
                            <L7p:TrueAssertion>
                                <L7p:AssertionComment assertionComment="included">
                                    <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="RIGHT.COMMENT"/>
                                    <L7p:value stringValue="// If cache deletion fail, it still continues with the major process but presents errors in auditing"/>
                                    </L7p:entry>
                                    </L7p:Properties>
                                </L7p:AssertionComment>
                            </L7p:TrueAssertion>
                            <L7p:assertionComment>
                                <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="RIGHT.COMMENT"/>
                                    <L7p:value stringValue="// Delete from cache of apiKey record"/>
                                    </L7p:entry>
                                </L7p:Properties>
                            </L7p:assertionComment>
                        </wsp:OneOrMore>
                        <L7p:assertionComment>
                            <L7p:Properties mapValue="included">
                                <L7p:entry>
                                    <L7p:key stringValue="RIGHT.COMMENT"/>
                                    <L7p:value stringValue="// Success"/>
                                </L7p:entry>
                            </L7p:Properties>
                        </L7p:assertionComment>
                    </wsp:All>
                    <wsp:All wsp:Usage="Required">
                        <L7p:ManipulateMultiValuedVariable>
                            <L7p:SourceVariableName stringValue="nextApiKey.current"/>
                            <L7p:TargetVariableName stringValue="failedDelete.list"/>
                        </L7p:ManipulateMultiValuedVariable>
                        <L7p:SetVariable>
                            <L7p:Base64Expression stringValue="MzAw"/>
                            <L7p:VariableToSet stringValue="error.code"/>
                        </L7p:SetVariable>
                        <L7p:assertionComment>
                            <L7p:Properties mapValue="included">
                                <L7p:entry>
                                    <L7p:key stringValue="RIGHT.COMMENT"/>
                                    <L7p:value stringValue="// Fail (300)"/>
                                </L7p:entry>
                            </L7p:Properties>
                        </L7p:assertionComment>
                    </wsp:All>
                    <L7p:assertionComment>
                        <L7p:Properties mapValue="included">
                            <L7p:entry>
                                <L7p:key stringValue="RIGHT.COMMENT"/>
                                <L7p:value stringValue="// Queries"/>
                            </L7p:entry>
                        </L7p:Properties>
                    </L7p:assertionComment>
                </wsp:OneOrMore>
                <L7p:assertionComment>
                    <L7p:Properties mapValue="included">
                        <L7p:entry>
                            <L7p:key stringValue="LEFT.COMMENT"/>
                            <L7p:value stringValue="apikeys"/>
                        </L7p:entry>
                        <L7p:entry>
                            <L7p:key stringValue="RIGHT.COMMENT"/>
                            <L7p:value stringValue="Delete API Keys and OAuth clients"/>
                        </L7p:entry>
                    </L7p:Properties>
                </L7p:assertionComment>
            </L7p:ForEachLoop>
            <L7p:assertionComment>
                <L7p:Properties mapValue="included">
                    <L7p:entry>
                        <L7p:key stringValue="RIGHT.COMMENT"/>
                        <L7p:value stringValue="Need to check if count is 0 before proceeding"/>
                    </L7p:entry>
                </L7p:Properties>
            </L7p:assertionComment>
        </wsp:OneOrMore>
        <L7p:CommentAssertion>
            <L7p:Comment stringValue="=== API Plan Feature Flag"/>
        </L7p:CommentAssertion>
        <wsp:OneOrMore wsp:Usage="Required">
            <L7p:EvaluateJsonPathExpression>
                <L7p:Expression stringValue="apiPlansEnabled"/>
                <L7p:OtherTargetMessageVariable stringValue="incomingJson"/>
                <L7p:Target target="OTHER"/>
                <L7p:VariablePrefix stringValue="apiPlan_enabled"/>
            </L7p:EvaluateJsonPathExpression>
            <L7p:SetVariable>
                <L7p:Base64Expression stringValue=""/>
                <L7p:VariableToSet stringValue="apiPlan_enabled.result"/>
            </L7p:SetVariable>
            <L7p:assertionComment>
                <L7p:Properties mapValue="included">
                    <L7p:entry>
                        <L7p:key stringValue="LEFT.COMMENT"/>
                        <L7p:value stringValue="check"/>
                    </L7p:entry>
                    <L7p:entry>
                        <L7p:key stringValue="RIGHT.COMMENT"/>
                        <L7p:value stringValue="Check if apiPlan feature flag were provided"/>
                    </L7p:entry>
                </L7p:Properties>
            </L7p:assertionComment>
        </wsp:OneOrMore>
        <L7p:CommentAssertion>
            <L7p:Comment stringValue="=== UPDATE - ADD"/>
        </L7p:CommentAssertion>
        <wsp:OneOrMore wsp:Usage="Required">
            <L7p:EvaluateJsonPathExpression>
                <L7p:Expression stringValue="newOrUpdatedEntities"/>
                <L7p:OtherTargetMessageVariable stringValue="incomingJson"/>
                <L7p:Target target="OTHER"/>
                <L7p:VariablePrefix stringValue="apikey_elements"/>
            </L7p:EvaluateJsonPathExpression>
            <wsp:All wsp:Usage="Required">
                <L7p:SetVariable>
                    <L7p:Base64Expression stringValue=""/>
                    <L7p:VariableToSet stringValue="apikey_elements.result"/>
                </L7p:SetVariable>
                <L7p:Split>
                    <L7p:IgnoreEmptyValues booleanValue="true"/>
                    <L7p:InputVariable stringValue="apikey_elements.result"/>
                    <L7p:OutputVariable stringValue="apikey_elements.results"/>
                </L7p:Split>
            </wsp:All>
            <L7p:assertionComment>
                <L7p:Properties mapValue="included">
                    <L7p:entry>
                        <L7p:key stringValue="LEFT.COMMENT"/>
                        <L7p:value stringValue="check"/>
                    </L7p:entry>
                    <L7p:entry>
                        <L7p:key stringValue="RIGHT.COMMENT"/>
                        <L7p:value stringValue="Check if any api keys were provided to be updated or created"/>
                    </L7p:entry>
                </L7p:Properties>
            </L7p:assertionComment>
        </wsp:OneOrMore>
        <wsp:All wsp:Usage="Required">
            <L7p:Encapsulated>
                <L7p:AssertionComment assertionComment="included">
                    <L7p:Properties mapValue="included">
                        <L7p:entry>
                            <L7p:key stringValue="RIGHT.COMMENT"/>
                            <L7p:value stringValue="generate lifetime for oauth clients"/>
                        </L7p:entry>
                    </L7p:Properties>
                </L7p:AssertionComment>
                <L7p:EncapsulatedAssertionConfigGuid stringValue="6dbc70f9-bb40-4a69-a0ec-88fae4f35300"/>
                <L7p:EncapsulatedAssertionConfigName stringValue="OTK Generate OAuth Token"/>
                <L7p:Parameters mapValue="included">
                    <L7p:entry>
                        <L7p:key stringValue="ac"/>
                        <L7p:value stringValue="false"/>
                    </L7p:entry>
                    <L7p:entry>
                        <L7p:key stringValue="art"/>
                        <L7p:value stringValue="false"/>
                    </L7p:entry>
                    <L7p:entry>
                        <L7p:key stringValue="at"/>
                        <L7p:value stringValue="false"/>
                    </L7p:entry>
                    <L7p:entry>
                        <L7p:key stringValue="cid"/>
                        <L7p:value stringValue="true"/>
                    </L7p:entry>
                    <L7p:entry>
                        <L7p:key stringValue="cidm"/>
                        <L7p:value stringValue="false"/>
                    </L7p:entry>
                    <L7p:entry>
                        <L7p:key stringValue="custom"/>
                        <L7p:value stringValue=""/>
                    </L7p:entry>
                    <L7p:entry>
                        <L7p:key stringValue="ock"/>
                        <L7p:value stringValue="false"/>
                    </L7p:entry>
                    <L7p:entry>
                        <L7p:key stringValue="ot"/>
                        <L7p:value stringValue="false"/>
                    </L7p:entry>
                    <L7p:entry>
                        <L7p:key stringValue="rft"/>
                        <L7p:value stringValue="false"/>
                    </L7p:entry>
                    <L7p:entry>
                        <L7p:key stringValue="urt"/>
                        <L7p:value stringValue="false"/>
                    </L7p:entry>
                </L7p:Parameters>
            </L7p:Encapsulated>
            <L7p:SetVariable>
                <L7p:Base64Expression stringValue="JHtnZW5FeHBpcmF0aW9ufQ=="/>
                <L7p:VariableToSet stringValue="expiration_otk_client"/>
            </L7p:SetVariable>
            <L7p:Encapsulated>
                <L7p:AssertionComment assertionComment="included">
                    <L7p:Properties mapValue="included">
                        <L7p:entry>
                            <L7p:key stringValue="RIGHT.COMMENT"/>
                            <L7p:value stringValue="generate lifetime for oauth clients used with MAG SDK"/>
                        </L7p:entry>
                    </L7p:Properties>
                </L7p:AssertionComment>
                <L7p:EncapsulatedAssertionConfigGuid stringValue="6dbc70f9-bb40-4a69-a0ec-88fae4f35300"/>
                <L7p:EncapsulatedAssertionConfigName stringValue="OTK Generate OAuth Token"/>
                <L7p:Parameters mapValue="included">
                    <L7p:entry>
                        <L7p:key stringValue="ac"/>
                        <L7p:value stringValue="false"/>
                    </L7p:entry>
                    <L7p:entry>
                        <L7p:key stringValue="art"/>
                        <L7p:value stringValue="false"/>
                    </L7p:entry>
                    <L7p:entry>
                        <L7p:key stringValue="at"/>
                        <L7p:value stringValue="false"/>
                    </L7p:entry>
                    <L7p:entry>
                        <L7p:key stringValue="cid"/>
                        <L7p:value stringValue="true"/>
                    </L7p:entry>
                    <L7p:entry>
                        <L7p:key stringValue="cidm"/>
                        <L7p:value stringValue="false"/>
                    </L7p:entry>
                    <L7p:entry>
                        <L7p:key stringValue="custom"/>
                        <L7p:value stringValue=""/>
                    </L7p:entry>
                    <L7p:entry>
                        <L7p:key stringValue="ock"/>
                        <L7p:value stringValue="false"/>
                    </L7p:entry>
                    <L7p:entry>
                        <L7p:key stringValue="ot"/>
                        <L7p:value stringValue="false"/>
                    </L7p:entry>
                    <L7p:entry>
                        <L7p:key stringValue="rft"/>
                        <L7p:value stringValue="false"/>
                    </L7p:entry>
                    <L7p:entry>
                        <L7p:key stringValue="urt"/>
                        <L7p:value stringValue="false"/>
                    </L7p:entry>
                </L7p:Parameters>
            </L7p:Encapsulated>
            <L7p:SetVariable>
                <L7p:Base64Expression stringValue="JHtnZW5FeHBpcmF0aW9ufQ=="/>
                <L7p:VariableToSet stringValue="expiration_otk_client_sdk"/>
            </L7p:SetVariable>
            <L7p:assertionComment>
                <L7p:Properties mapValue="included">
                    <L7p:entry>
                        <L7p:key stringValue="LEFT.COMMENT"/>
                        <L7p:value stringValue="lifetimes"/>
                    </L7p:entry>
                    <L7p:entry>
                        <L7p:key stringValue="RIGHT.COMMENT"/>
                        <L7p:value stringValue="Generate lifetimes for oauth clients"/>
                    </L7p:entry>
                </L7p:Properties>
            </L7p:assertionComment>
        </wsp:All>
        <wsp:OneOrMore wsp:Usage="Required">
            <L7p:ComparisonAssertion>
                <L7p:CaseSensitive booleanValue="false"/>
                <L7p:Expression1 stringValue="${apikey_elements.count}"/>
                <L7p:Operator operatorNull="null"/>
                <L7p:Predicates predicates="included">
                    <L7p:item dataType="included">
                        <L7p:Type variableDataType="int"/>
                    </L7p:item>
                    <L7p:item binary="included">
                        <L7p:CaseSensitive booleanValue="false"/>
                        <L7p:RightValue stringValue="0"/>
                    </L7p:item>
                </L7p:Predicates>
            </L7p:ComparisonAssertion>
            <L7p:ForEachLoop L7p:Usage="Required"
                loopVariable="apikey_elements.results" variablePrefix="nextApiKey">
                <L7p:SetVariable>
                    <L7p:AssertionComment assertionComment="included">
                        <L7p:Properties mapValue="included">
                            <L7p:entry>
                                <L7p:key stringValue="LEFT.COMMENT"/>
                                <L7p:value stringValue="initialize"/>
                            </L7p:entry>
                            <L7p:entry>
                                <L7p:key stringValue="RIGHT.COMMENT"/>
                                <L7p:value stringValue="will be overwritten in the case of an error"/>
                            </L7p:entry>
                        </L7p:Properties>
                    </L7p:AssertionComment>
                    <L7p:Base64Expression stringValue="JHtuZXh0QXBpS2V5LmN1cnJlbnR9"/>
                    <L7p:ContentType stringValue="application/json; charset=utf-8"/>
                    <L7p:DataType variableDataType="message"/>
                    <L7p:VariableToSet stringValue="nextApiKeyJSON"/>
                </L7p:SetVariable>
                <L7p:SetVariable>
                    <L7p:AssertionComment assertionComment="included">
                        <L7p:Properties mapValue="included">
                            <L7p:entry>
                                <L7p:key stringValue="LEFT.COMMENT"/>
                                <L7p:value stringValue="initialize"/>
                            </L7p:entry>
                            <L7p:entry>
                                <L7p:key stringValue="RIGHT.COMMENT"/>
                                <L7p:value stringValue="// list of apikey#apiid#planid for portal api key cache upsert"/>
                            </L7p:entry>
                        </L7p:Properties>
                    </L7p:AssertionComment>
                    <L7p:Base64Expression stringValue=""/>
                    <L7p:VariableToSet stringValue="idlist"/>
                </L7p:SetVariable>
                <wsp:All wsp:Usage="Required">
                    <wsp:OneOrMore wsp:Usage="Required">
                        <wsp:All wsp:Usage="Required">
                            <L7p:EvaluateJsonPathExpression>
                                <L7p:Expression stringValue="id"/>
                                <L7p:OtherTargetMessageVariable stringValue="nextApiKeyJSON"/>
                                <L7p:Target target="OTHER"/>
                                <L7p:VariablePrefix stringValue="client_ident"/>
                            </L7p:EvaluateJsonPathExpression>
                            <L7p:EvaluateJsonPathExpression>
                                <L7p:Expression stringValue="key"/>
                                <L7p:OtherTargetMessageVariable stringValue="nextApiKeyJSON"/>
                                <L7p:Target target="OTHER"/>
                                <L7p:VariablePrefix stringValue="client_key"/>
                            </L7p:EvaluateJsonPathExpression>
                            <L7p:EvaluateJsonPathExpression>
                                <L7p:Expression stringValue="secret"/>
                                <L7p:OtherTargetMessageVariable stringValue="nextApiKeyJSON"/>
                                <L7p:Target target="OTHER"/>
                                <L7p:VariablePrefix stringValue="secret"/>
                            </L7p:EvaluateJsonPathExpression>
                            <L7p:EvaluateJsonPathExpression>
                                <L7p:Expression stringValue="status"/>
                                <L7p:OtherTargetMessageVariable stringValue="nextApiKeyJSON"/>
                                <L7p:Target target="OTHER"/>
                                <L7p:VariablePrefix stringValue="status"/>
                            </L7p:EvaluateJsonPathExpression>
                            <L7p:EvaluateJsonPathExpression>
                                <L7p:Expression stringValue="organizationId"/>
                                <L7p:OtherTargetMessageVariable stringValue="nextApiKeyJSON"/>
                                <L7p:Target target="OTHER"/>
                                <L7p:VariablePrefix stringValue="organizationId"/>
                            </L7p:EvaluateJsonPathExpression>
                            <L7p:EvaluateJsonPathExpression>
                                <L7p:Expression stringValue="organizationName"/>
                                <L7p:OtherTargetMessageVariable stringValue="nextApiKeyJSON"/>
                                <L7p:Target target="OTHER"/>
                                <L7p:VariablePrefix stringValue="organization"/>
                            </L7p:EvaluateJsonPathExpression>
                            <L7p:EvaluateJsonPathExpression>
                                <L7p:Expression stringValue="label"/>
                                <L7p:OtherTargetMessageVariable stringValue="nextApiKeyJSON"/>
                                <L7p:Target target="OTHER"/>
                                <L7p:VariablePrefix stringValue="name"/>
                            </L7p:EvaluateJsonPathExpression>
                            <wsp:OneOrMore wsp:Usage="Required">
                                <L7p:EvaluateJsonPathExpression>
                                    <L7p:Expression stringValue="oauthCallbackUrl"/>
                                    <L7p:OtherTargetMessageVariable stringValue="nextApiKeyJSON"/>
                                    <L7p:Target target="OTHER"/>
                                    <L7p:VariablePrefix stringValue="callback"/>
                                </L7p:EvaluateJsonPathExpression>
                                <L7p:SetVariable>
                                    <L7p:Base64Expression stringValue="b29i"/>
                                    <L7p:VariableToSet stringValue="callback.result"/>
                                </L7p:SetVariable>
                                <L7p:assertionComment>
                                    <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="RIGHT.COMMENT"/>
                                    <L7p:value stringValue="// oauthcallbackUri"/>
                                    </L7p:entry>
                                    </L7p:Properties>
                                </L7p:assertionComment>
                            </wsp:OneOrMore>
                            <wsp:OneOrMore wsp:Usage="Required">
                                <L7p:EvaluateJsonPathExpression>
                                    <L7p:Expression stringValue="oauthScope"/>
                                    <L7p:OtherTargetMessageVariable stringValue="nextApiKeyJSON"/>
                                    <L7p:Target target="OTHER"/>
                                    <L7p:VariablePrefix stringValue="oauth_scope"/>
                                </L7p:EvaluateJsonPathExpression>
                                <L7p:SetVariable>
                                    <L7p:Base64Expression stringValue="b29i"/>
                                    <L7p:VariableToSet stringValue="oauth_scope.result"/>
                                </L7p:SetVariable>
                                <L7p:assertionComment>
                                    <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="RIGHT.COMMENT"/>
                                    <L7p:value stringValue="// oauthScope"/>
                                    </L7p:entry>
                                    </L7p:Properties>
                                </L7p:assertionComment>
                            </wsp:OneOrMore>
                            <wsp:OneOrMore wsp:Usage="Required">
                                <L7p:EvaluateJsonPathExpression>
                                    <L7p:Expression stringValue="oauthType"/>
                                    <L7p:OtherTargetMessageVariable stringValue="nextApiKeyJSON"/>
                                    <L7p:Target target="OTHER"/>
                                    <L7p:VariablePrefix stringValue="type"/>
                                </L7p:EvaluateJsonPathExpression>
                                <L7p:SetVariable>
                                    <L7p:Base64Expression stringValue="cHVibGlj"/>
                                    <L7p:VariableToSet stringValue="type.result"/>
                                </L7p:SetVariable>
                                <L7p:assertionComment>
                                    <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="RIGHT.COMMENT"/>
                                    <L7p:value stringValue="// oauthType"/>
                                    </L7p:entry>
                                    </L7p:Properties>
                                </L7p:assertionComment>
                            </wsp:OneOrMore>
                            <wsp:OneOrMore wsp:Usage="Required">
                                <L7p:EvaluateJsonPathExpression>
                                    <L7p:AssertionComment assertionComment="included">
                                    <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="RIGHT.COMMENT"/>
                                    <L7p:value stringValue="// should always have a value"/>
                                    </L7p:entry>
                                    </L7p:Properties>
                                    </L7p:AssertionComment>
                                    <L7p:Expression stringValue="createdBy"/>
                                    <L7p:OtherTargetMessageVariable stringValue="nextApiKeyJSON"/>
                                    <L7p:Target target="OTHER"/>
                                    <L7p:VariablePrefix stringValue="registered_by"/>
                                </L7p:EvaluateJsonPathExpression>
                                <L7p:SetVariable>
                                    <L7p:Base64Expression stringValue="Q0EgQVBJIFBvcnRhbA=="/>
                                    <L7p:VariableToSet stringValue="registered_by.result"/>
                                </L7p:SetVariable>
                                <L7p:assertionComment>
                                    <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="RIGHT.COMMENT"/>
                                    <L7p:value stringValue="// createdBy"/>
                                    </L7p:entry>
                                    </L7p:Properties>
                                </L7p:assertionComment>
                            </wsp:OneOrMore>
                            <L7p:SetVariable>
                                <L7p:AssertionComment assertionComment="included">
                                    <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="RIGHT.COMMENT"/>
                                    <L7p:value stringValue="Use 'created_by' for missing 'modified_by'"/>
                                    </L7p:entry>
                                    </L7p:Properties>
                                </L7p:AssertionComment>
                                <L7p:Base64Expression stringValue="JHtyZWdpc3RlcmVkX2J5LnJlc3VsdH0="/>
                                <L7p:VariableToSet stringValue="registered_by"/>
                            </L7p:SetVariable>
                            <wsp:OneOrMore wsp:Usage="Required">
                                <L7p:EvaluateJsonPathExpression>
                                    <L7p:Expression stringValue="modifiedBy"/>
                                    <L7p:OtherTargetMessageVariable stringValue="nextApiKeyJSON"/>
                                    <L7p:Target target="OTHER"/>
                                    <L7p:VariablePrefix stringValue="modifiedBy"/>
                                </L7p:EvaluateJsonPathExpression>
                                <L7p:SetVariable>
                                    <L7p:Base64Expression stringValue="JHtyZWdpc3RlcmVkX2J5fQ=="/>
                                    <L7p:VariableToSet stringValue="modifiedBy.result"/>
                                </L7p:SetVariable>
                                <L7p:assertionComment>
                                    <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="RIGHT.COMMENT"/>
                                    <L7p:value stringValue="// modifiedBy"/>
                                    </L7p:entry>
                                    </L7p:Properties>
                                </L7p:assertionComment>
                            </wsp:OneOrMore>
                            <wsp:OneOrMore wsp:Usage="Required">
                                <L7p:EvaluateJsonPathExpression>
                                    <L7p:Expression stringValue="custom"/>
                                    <L7p:OtherTargetMessageVariable stringValue="nextApiKeyJSON"/>
                                    <L7p:Target target="OTHER"/>
                                    <L7p:VariablePrefix stringValue="customMetaData"/>
                                </L7p:EvaluateJsonPathExpression>
                                <L7p:SetVariable>
                                    <L7p:Base64Expression stringValue=""/>
                                    <L7p:VariableToSet stringValue="customMetaData.result"/>
                                </L7p:SetVariable>
                                <L7p:assertionComment>
                                    <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="RIGHT.COMMENT"/>
                                    <L7p:value stringValue="// customMetaData"/>
                                    </L7p:entry>
                                    </L7p:Properties>
                                </L7p:assertionComment>
                            </wsp:OneOrMore>
                            <wsp:OneOrMore wsp:Usage="Required">
                                <wsp:All wsp:Usage="Required">
                                    <L7p:EvaluateJsonPathExpression>
                                    <L7p:Expression stringValue="hashingMetadata"/>
                                    <L7p:OtherTargetMessageVariable stringValue="nextApiKeyJSON"/>
                                    <L7p:Target target="OTHER"/>
                                    <L7p:VariablePrefix stringValue="hashing_metadata"/>
                                    </L7p:EvaluateJsonPathExpression>
                                    <L7p:SetVariable>
                                    <L7p:Base64Expression stringValue="dHJ1ZQ=="/>
                                    <L7p:VariableToSet stringValue="hashmeta_exists"/>
                                    </L7p:SetVariable>
                                    <L7p:SetVariable>
                                    <L7p:Base64Expression stringValue="JHtoYXNoaW5nX21ldGFkYXRhLnJlc3VsdH0="/>
                                    <L7p:ContentType stringValue="application/json; charset=utf-8"/>
                                    <L7p:DataType variableDataType="message"/>
                                    <L7p:VariableToSet stringValue="hashmeta"/>
                                    </L7p:SetVariable>
                                </wsp:All>
                                <wsp:All wsp:Usage="Required">
                                    <L7p:SetVariable>
                                    <L7p:Base64Expression stringValue=""/>
                                    <L7p:ContentType stringValue="application/json; charset=utf-8"/>
                                    <L7p:DataType variableDataType="message"/>
                                    <L7p:VariableToSet stringValue="hashing_metadata.result"/>
                                    </L7p:SetVariable>
                                    <L7p:SetVariable>
                                    <L7p:Base64Expression stringValue=""/>
                                    <L7p:ContentType stringValue="application/json; charset=utf-8"/>
                                    <L7p:DataType variableDataType="message"/>
                                    <L7p:VariableToSet stringValue="hashmeta"/>
                                    </L7p:SetVariable>
                                    <L7p:SetVariable>
                                    <L7p:Base64Expression stringValue="ZmFsc2U="/>
                                    <L7p:VariableToSet stringValue="hashmeta_exists"/>
                                    </L7p:SetVariable>
                                </wsp:All>
                                <L7p:assertionComment>
                                    <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="RIGHT.COMMENT"/>
                                    <L7p:value stringValue="// hashing metadata"/>
                                    </L7p:entry>
                                    </L7p:Properties>
                                </L7p:assertionComment>
                            </wsp:OneOrMore>
                            <wsp:OneOrMore wsp:Usage="Required">
                                <L7p:ComparisonAssertion>
                                    <L7p:CaseSensitive booleanValue="false"/>
                                    <L7p:Expression1 stringValue="${hashmeta_exists}"/>
                                    <L7p:Operator operatorNull="null"/>
                                    <L7p:Predicates predicates="included">
                                    <L7p:item dataType="included">
                                    <L7p:Type variableDataType="string"/>
                                    </L7p:item>
                                    <L7p:item binary="included">
                                    <L7p:RightValue stringValue="false"/>
                                    </L7p:item>
                                    </L7p:Predicates>
                                </L7p:ComparisonAssertion>
                                <wsp:All wsp:Usage="Required">
                                    <L7p:EvaluateJsonPathExpression>
                                    <L7p:Expression stringValue="algorithm"/>
                                    <L7p:OtherTargetMessageVariable stringValue="hashmeta"/>
                                    <L7p:Target target="OTHER"/>
                                    <L7p:VariablePrefix stringValue="hashing_metadata_algorithm"/>
                                    </L7p:EvaluateJsonPathExpression>
                                    <wsp:All wsp:Usage="Required">
                                    <L7p:EvaluateJsonPathExpression>
                                    <L7p:Expression stringValue="salt"/>

                                    <L7p:OtherTargetMessageVariable stringValue="hashmeta"/>
                                    <L7p:Target target="OTHER"/>
                                    <L7p:VariablePrefix stringValue="hashing_metadata_salt"/>
                                    </L7p:EvaluateJsonPathExpression>
                                    <L7p:ComparisonAssertion>
                                    <L7p:CaseSensitive booleanValue="false"/>
                                    <L7p:Expression1 stringValue="${hashing_metadata_salt.result}"/>
                                    <L7p:Operator operatorNull="null"/>
                                    <L7p:Predicates predicates="included">
                                    <L7p:item dataType="included">
                                    <L7p:Type variableDataType="string"/>
                                    </L7p:item>
                                    <L7p:item binary="included">
                                    <L7p:Negated booleanValue="true"/>
                                    <L7p:Operator operator="EMPTY"/>
                                    <L7p:RightValue stringValue=""/>
                                    </L7p:item>
                                    </L7p:Predicates>
                                    </L7p:ComparisonAssertion>
                                    </wsp:All>
                                    <wsp:OneOrMore wsp:Usage="Required">
                                    <wsp:All wsp:Usage="Required">
                                    <L7p:ComparisonAssertion>
                                    <L7p:CaseSensitive booleanValue="false"/>
                                    <L7p:Expression1 stringValue="${hashing_metadata_algorithm.result}"/>
                                    <L7p:Operator operatorNull="null"/>
                                    <L7p:Predicates predicates="included">
                                    <L7p:item dataType="included">
                                    <L7p:Type variableDataType="string"/>
                                    </L7p:item>
                                    <L7p:item binary="included">
                                    <L7p:RightValue stringValue="MD5"/>
                                    </L7p:item>
                                    </L7p:Predicates>
                                    </L7p:ComparisonAssertion>
                                    </wsp:All>
                                    <wsp:All wsp:Usage="Required">
                                    <L7p:ComparisonAssertion>
                                    <L7p:CaseSensitive booleanValue="false"/>
                                    <L7p:Expression1 stringValue="${hashing_metadata_algorithm.result}"/>
                                    <L7p:Operator operatorNull="null"/>
                                    <L7p:Predicates predicates="included">
                                    <L7p:item dataType="included">
                                    <L7p:Type variableDataType="string"/>
                                    </L7p:item>
                                    <L7p:item binary="included">
                                    <L7p:RightValue stringValue="SHA-1"/>
                                    </L7p:item>
                                    </L7p:Predicates>
                                    </L7p:ComparisonAssertion>
                                    </wsp:All>
                                    <wsp:All wsp:Usage="Required">
                                    <L7p:ComparisonAssertion>
                                    <L7p:CaseSensitive booleanValue="false"/>
                                    <L7p:Expression1 stringValue="${hashing_metadata_algorithm.result}"/>
                                    <L7p:Operator operatorNull="null"/>
                                    <L7p:Predicates predicates="included">
                                    <L7p:item dataType="included">
                                    <L7p:Type variableDataType="string"/>
                                    </L7p:item>
                                    <L7p:item binary="included">
                                    <L7p:RightValue stringValue="SHA-256"/>
                                    </L7p:item>
                                    </L7p:Predicates>
                                    </L7p:ComparisonAssertion>
                                    </wsp:All>
                                    <wsp:All wsp:Usage="Required">
                                    <L7p:ComparisonAssertion>
                                    <L7p:CaseSensitive booleanValue="false"/>
                                    <L7p:Expression1 stringValue="${hashing_metadata_algorithm.result}"/>
                                    <L7p:Operator operatorNull="null"/>
                                    <L7p:Predicates predicates="included">
                                    <L7p:item dataType="included">
                                    <L7p:Type variableDataType="string"/>
                                    </L7p:item>
                                    <L7p:item binary="included">
                                    <L7p:RightValue stringValue="SHA-384"/>
                                    </L7p:item>
                                    </L7p:Predicates>
                                    </L7p:ComparisonAssertion>
                                    </wsp:All>
                                    <wsp:All wsp:Usage="Required">
                                    <L7p:ComparisonAssertion>
                                    <L7p:CaseSensitive booleanValue="false"/>
                                    <L7p:Expression1 stringValue="${hashing_metadata_algorithm.result}"/>
                                    <L7p:Operator operatorNull="null"/>
                                    <L7p:Predicates predicates="included">
                                    <L7p:item dataType="included">
                                    <L7p:Type variableDataType="string"/>
                                    </L7p:item>
                                    <L7p:item binary="included">
                                    <L7p:RightValue stringValue="SHA-512"/>
                                    </L7p:item>
                                    </L7p:Predicates>
                                    </L7p:ComparisonAssertion>
                                    </wsp:All>
                                    <wsp:All wsp:Usage="Required">
                                    <L7p:SetVariable>
                                    <L7p:Base64Expression stringValue="MzAw"/>
                                    <L7p:VariableToSet stringValue="error.code"/>
                                    </L7p:SetVariable>
                                    <L7p:FalseAssertion/>
                                    </wsp:All>
                                    </wsp:OneOrMore>
                                </wsp:All>
                                <L7p:assertionComment>
                                    <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="RIGHT.COMMENT"/>
                                    <L7p:value stringValue="Validate Hashed Metadata"/>
                                    </L7p:entry>
                                    </L7p:Properties>
                                </L7p:assertionComment>
                            </wsp:OneOrMore>
                            <wsp:OneOrMore wsp:Usage="Required">
                                <wsp:All wsp:Usage="Required">
                                    <L7p:ComparisonAssertion>
                                    <L7p:CaseSensitive booleanValue="false"/>
                                    <L7p:Expression1 stringValue="${apiPlan_enabled.result}"/>
                                    <L7p:Expression2 stringValue="true"/>
                                    <L7p:Predicates predicates="included">
                                    <L7p:item binary="included">
                                    <L7p:CaseSensitive booleanValue="false"/>
                                    <L7p:RightValue stringValue="true"/>
                                    </L7p:item>
                                    </L7p:Predicates>
                                    </L7p:ComparisonAssertion>
                                    <L7p:EvaluateJsonPathExpression>
                                    <L7p:Expression stringValue="apis"/>
                                    <L7p:OtherTargetMessageVariable stringValue="nextApiKeyJSON"/>
                                    <L7p:Target target="OTHER"/>
                                    <L7p:VariablePrefix stringValue="apis"/>
                                    </L7p:EvaluateJsonPathExpression>
                                    <L7p:SetVariable>
                                    <L7p:Base64Expression stringValue=""/>
                                    <L7p:VariableToSet stringValue="api_plans"/>
                                    </L7p:SetVariable>
                                    <L7p:SetVariable>
                                    <L7p:Base64Expression stringValue=""/>
                                    <L7p:VariableToSet stringValue="api_ids"/>
                                    </L7p:SetVariable>
                                    <L7p:ForEachLoop
                                    L7p:Usage="Required"
                                    loopVariable="apis.results" variablePrefix="api">
                                    <L7p:SetVariable>
                                    <L7p:Base64Expression stringValue="JHthcGkuY3VycmVudH0="/>
                                    <L7p:ContentType stringValue="application/json; charset=utf-8"/>
                                    <L7p:DataType variableDataType="message"/>
                                    <L7p:VariableToSet stringValue="api_map"/>
                                    </L7p:SetVariable>
                                    <L7p:EvaluateJsonPathExpression>
                                    <L7p:Expression stringValue="id"/>

                                    <L7p:OtherTargetMessageVariable stringValue="api_map"/>
                                    <L7p:Target target="OTHER"/>
                                    <L7p:VariablePrefix stringValue="id"/>
                                    </L7p:EvaluateJsonPathExpression>
                                    <L7p:EvaluateJsonPathExpression>
                                    <L7p:Expression stringValue="planId"/>

                                    <L7p:OtherTargetMessageVariable stringValue="api_map"/>
                                    <L7p:Target target="OTHER"/>
                                    <L7p:VariablePrefix stringValue="planId"/>
                                    </L7p:EvaluateJsonPathExpression>
                                    <L7p:ComparisonAssertion>
                                    <L7p:CaseSensitive booleanValue="false"/>
                                    <L7p:Expression1 stringValue="${id.result}"/>
                                    <L7p:Expression2 stringValue="false"/>
                                    <L7p:Negate booleanValue="true"/>
                                    <L7p:Operator operator="EMPTY"/>
                                    <L7p:Predicates predicates="included">
                                    <L7p:item binary="included">
                                    <L7p:CaseSensitive booleanValue="false"/>
                                    <L7p:Negated booleanValue="true"/>
                                    <L7p:Operator operator="EMPTY"/>
                                    <L7p:RightValue stringValue="false"/>
                                    </L7p:item>
                                    </L7p:Predicates>
                                    </L7p:ComparisonAssertion>
                                    <L7p:ComparisonAssertion>
                                    <L7p:CaseSensitive booleanValue="false"/>
                                    <L7p:Expression1 stringValue="${planId.result}"/>
                                    <L7p:Expression2 stringValue="false"/>
                                    <L7p:Negate booleanValue="true"/>
                                    <L7p:Operator operator="EMPTY"/>
                                    <L7p:Predicates predicates="included">
                                    <L7p:item binary="included">
                                    <L7p:CaseSensitive booleanValue="false"/>
                                    <L7p:Negated booleanValue="true"/>
                                    <L7p:Operator operator="EMPTY"/>
                                    <L7p:RightValue stringValue="false"/>
                                    </L7p:item>
                                    </L7p:Predicates>
                                    </L7p:ComparisonAssertion>
                                    <L7p:SetVariable>
                                    <L7p:Base64Expression stringValue="PGw3OkFwaSBhcGlJZD0iJHtpZC5yZXN1bHR9IiBwbGFuSWQ9IiR7cGxhbklkLnJlc3VsdH0iLz4="/>
                                    <L7p:VariableToSet stringValue="apiplan"/>
                                    </L7p:SetVariable>
                                    <L7p:SetVariable>
                                    <L7p:Base64Expression stringValue="JHthcGlfcGxhbnN9DQoke2FwaXBsYW59"/>
                                    <L7p:VariableToSet stringValue="api_plans"/>
                                    </L7p:SetVariable>
                                    <L7p:SetVariable>
                                    <L7p:Base64Expression stringValue="JHthcGlfaWRzfSwke2lkLnJlc3VsdH0="/>
                                    <L7p:VariableToSet stringValue="api_ids"/>
                                    </L7p:SetVariable>
                                    <L7p:SetVariable>
                                    <L7p:Base64Expression stringValue="JHtpZGxpc3R9LCR7Y2xpZW50X2tleS5yZXN1bHR9IyR7aWQucmVzdWx0fSMke3BsYW5JZC5yZXN1bHR9"/>
                                    <L7p:VariableToSet stringValue="idlist"/>
                                    </L7p:SetVariable>
                                    </L7p:ForEachLoop>
                                    <L7p:Regex>
                                    <L7p:AutoTarget booleanValue="false"/>
                                    <L7p:FindAll booleanValue="true"/>
                                    <L7p:OtherTargetMessageVariable stringValue="api_ids"/>
                                    <L7p:Regex stringValue="\s|^,"/>
                                    <L7p:Replace booleanValue="true"/>
                                    <L7p:Replacement stringValue=""/>
                                    <L7p:Target target="OTHER"/>
                                    </L7p:Regex>
                                    <L7p:Regex>
                                    <L7p:AutoTarget booleanValue="false"/>
                                    <L7p:FindAll booleanValue="true"/>
                                    <L7p:OtherTargetMessageVariable stringValue="idlist"/>
                                    <L7p:Regex stringValue="\s|^,"/>
                                    <L7p:Replace booleanValue="true"/>
                                    <L7p:Replacement stringValue=""/>
                                    <L7p:Target target="OTHER"/>
                                    </L7p:Regex>
                                    <L7p:assertionComment>
                                    <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="RIGHT.COMMENT"/>
                                    <L7p:value stringValue="// Deal with format with apiPlanEnabled=true"/>
                                    </L7p:entry>
                                    </L7p:Properties>
                                    </L7p:assertionComment>
                                </wsp:All>
                                <wsp:All wsp:Usage="Required">
                                    <L7p:EvaluateJsonPathExpression>
                                    <L7p:Expression stringValue="apis.*"/>
                                    <L7p:OtherTargetMessageVariable stringValue="nextApiKeyJSON"/>
                                    <L7p:Target target="OTHER"/>
                                    <L7p:VariablePrefix stringValue="apis"/>
                                    </L7p:EvaluateJsonPathExpression>
                                    <L7p:Regex>
                                    <L7p:AutoTarget booleanValue="false"/>
                                    <L7p:FindAll booleanValue="true"/>
                                    <L7p:OtherTargetMessageVariable stringValue="apis.results"/>
                                    <L7p:Regex stringValue="\s|\[|\]"/>
                                    <L7p:Replace booleanValue="true"/>
                                    <L7p:Replacement stringValue=""/>
                                    <L7p:Target target="OTHER"/>
                                    </L7p:Regex>
                                    <L7p:SetVariable>
                                    <L7p:Base64Expression stringValue="PGw3OkFwaSBhcGlJZD0iJHthcGlzLnJlc3VsdHN9IiBwbGFuSWQ9Im5vLWFwaS1wbGFuLXlldCIvPg=="/>
                                    <L7p:VariableToSet stringValue="api_plans"/>
                                    </L7p:SetVariable>
                                    <L7p:SetVariable>
                                    <L7p:Base64Expression stringValue="JHthcGlzLnJlc3VsdHN9"/>
                                    <L7p:VariableToSet stringValue="api_ids"/>
                                    </L7p:SetVariable>
                                    <L7p:assertionComment>
                                    <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="RIGHT.COMMENT"/>
                                    <L7p:value stringValue="// Deal with format with apiPlanEnabled=false or not provided"/>
                                    </L7p:entry>
                                    </L7p:Properties>
                                    </L7p:assertionComment>
                                </wsp:All>
                                <L7p:assertionComment>
                                    <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="RIGHT.COMMENT"/>
                                    <L7p:value stringValue="// Deal with format w/o apiPlanEnabled=true"/>
                                    </L7p:entry>
                                    </L7p:Properties>
                                </L7p:assertionComment>
                            </wsp:OneOrMore>
                            <L7p:assertionComment>
                                <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="RIGHT.COMMENT"/>
                                    <L7p:value stringValue="// Parse the required elements"/>
                                    </L7p:entry>
                                </L7p:Properties>
                            </L7p:assertionComment>
                        </wsp:All>
                        <wsp:All wsp:Usage="Required">
                            <L7p:SetVariable>
                                <L7p:Base64Expression stringValue="MzAw"/>
                                <L7p:VariableToSet stringValue="error.code"/>
                            </L7p:SetVariable>
                            <L7p:FalseAssertion/>
                            <L7p:assertionComment>
                                <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="RIGHT.COMMENT"/>
                                    <L7p:value stringValue="// Fail (300)"/>
                                    </L7p:entry>
                                </L7p:Properties>
                            </L7p:assertionComment>
                        </wsp:All>
                        <L7p:assertionComment>
                            <L7p:Properties mapValue="included">
                                <L7p:entry>
                                    <L7p:key stringValue="RIGHT.COMMENT"/>
                                    <L7p:value stringValue="// Parse required elements else fail (300)"/>
                                </L7p:entry>
                            </L7p:Properties>
                        </L7p:assertionComment>
                    </wsp:OneOrMore>
                    <wsp:All wsp:Usage="Required">
                        <L7p:SetVariable>
                            <L7p:Base64Expression stringValue="JHtjbGllbnRfaWRlbnQucmVzdWx0fQ=="/>
                            <L7p:VariableToSet stringValue="client_ident"/>
                        </L7p:SetVariable>
                        <L7p:SetVariable>
                            <L7p:Base64Expression stringValue="JHtjbGllbnRfa2V5LnJlc3VsdH0="/>
                            <L7p:VariableToSet stringValue="client_key"/>
                        </L7p:SetVariable>
                        <L7p:SetVariable>
                            <L7p:Base64Expression stringValue="JHtzZWNyZXQucmVzdWx0fQ=="/>
                            <L7p:VariableToSet stringValue="secret"/>
                        </L7p:SetVariable>
                        <L7p:SetVariable>
                            <L7p:Base64Expression stringValue="JHtvcmdhbml6YXRpb25JZC5yZXN1bHR9"/>
                            <L7p:VariableToSet stringValue="organization_id"/>
                        </L7p:SetVariable>
                        <L7p:SetVariable>
                            <L7p:Base64Expression stringValue="JHtvcmdhbml6YXRpb24ucmVzdWx0fQ=="/>
                            <L7p:VariableToSet stringValue="organization"/>
                        </L7p:SetVariable>
                        <L7p:SetVariable>
                            <L7p:Base64Expression stringValue="JHtuYW1lLnJlc3VsdH0="/>
                            <L7p:VariableToSet stringValue="name"/>
                        </L7p:SetVariable>
                        <L7p:SetVariable>
                            <L7p:Base64Expression stringValue="JHtzdGF0dXMucmVzdWx0fQ=="/>
                            <L7p:VariableToSet stringValue="status"/>
                        </L7p:SetVariable>
                        <L7p:SetVariable>
                            <L7p:Base64Expression stringValue="JHtzdGF0dXN9"/>
                            <L7p:VariableToSet stringValue="oauth_client_status"/>
                        </L7p:SetVariable>
                        <L7p:SetVariable>
                            <L7p:Base64Expression stringValue="JHtoYXNoaW5nX21ldGFkYXRhLnJlc3VsdH0="/>
                            <L7p:ContentType stringValue="application/json; charset=utf-8"/>
                            <L7p:DataType variableDataType="message"/>
                            <L7p:VariableToSet stringValue="hashing_metadata"/>
                        </L7p:SetVariable>
                        <wsp:OneOrMore wsp:Usage="Required">
                            <wsp:All wsp:Usage="Required">
                                <L7p:ComparisonAssertion>
                                    <L7p:CaseSensitive booleanValue="false"/>
                                    <L7p:Expression1 stringValue="${oauth_client_status}"/>
                                    <L7p:Expression2 stringValue="active"/>
                                    <L7p:Predicates predicates="included">
                                    <L7p:item binary="included">
                                    <L7p:CaseSensitive booleanValue="false"/>
                                    <L7p:RightValue stringValue="active"/>
                                    </L7p:item>
                                    </L7p:Predicates>
                                </L7p:ComparisonAssertion>
                                <L7p:SetVariable>
                                    <L7p:Base64Expression stringValue="RU5BQkxFRA=="/>
                                    <L7p:VariableToSet stringValue="oauth_client_status"/>
                                </L7p:SetVariable>
                            </wsp:All>
                            <L7p:SetVariable>
                                <L7p:Base64Expression stringValue="RElTQUJMRUQ="/>
                                <L7p:VariableToSet stringValue="oauth_client_status"/>
                            </L7p:SetVariable>
                            <L7p:assertionComment>
                                <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="RIGHT.COMMENT"/>
                                    <L7p:value stringValue="translate status from active to ENABLED for OTK clients"/>
                                    </L7p:entry>
                                </L7p:Properties>
                            </L7p:assertionComment>
                        </wsp:OneOrMore>
                        <L7p:SetVariable>
                            <L7p:Base64Expression stringValue="JHtjYWxsYmFjay5yZXN1bHR9"/>
                            <L7p:VariableToSet stringValue="oauth_callback"/>
                        </L7p:SetVariable>
                        <L7p:SetVariable>
                            <L7p:Base64Expression stringValue="JHtvYXV0aF9zY29wZS5yZXN1bHR9"/>
                            <L7p:VariableToSet stringValue="oauth_scope"/>
                        </L7p:SetVariable>
                        <L7p:SetVariable>
                            <L7p:Base64Expression stringValue="JHt0eXBlLnJlc3VsdH0="/>
                            <L7p:VariableToSet stringValue="type"/>
                        </L7p:SetVariable>
                        <L7p:SetVariable>
                            <L7p:Base64Expression stringValue="JHttb2RpZmllZEJ5LnJlc3VsdH0="/>
                            <L7p:VariableToSet stringValue="modified_by"/>
                        </L7p:SetVariable>
                        <L7p:SetVariable>
                            <L7p:Base64Expression stringValue="JHttYWdfc2NvcGUucmVzdWx0fQ=="/>
                            <L7p:VariableToSet stringValue="mag_scope"/>
                        </L7p:SetVariable>
                        <L7p:SetVariable>
                            <L7p:Base64Expression stringValue="JHttYWdfY2FsbGJhY2sucmVzdWx0fQ=="/>
                            <L7p:VariableToSet stringValue="mag_callback"/>
                        </L7p:SetVariable>
                        <L7p:SetVariable>
                            <L7p:Base64Expression stringValue="Q3JlYXRlZCBieSBMYXllcjcgQVBJIERldmVsb3BlciBQb3J0YWw="/>
                            <L7p:VariableToSet stringValue="description"/>
                        </L7p:SetVariable>
                        <L7p:SetVariable>
                            <L7p:Base64Expression stringValue="eyJhcGlLZXkiOiIke2NsaWVudF9rZXl9In0="/>
                            <L7p:VariableToSet stringValue="custom"/>
                        </L7p:SetVariable>
                        <L7p:SetVariable>
                            <L7p:Base64Expression stringValue="JHtjdXN0b21NZXRhRGF0YS5yZXN1bHR9"/>
                            <L7p:VariableToSet stringValue="customMetaData"/>
                        </L7p:SetVariable>
                        <L7p:SetVariable>
                            <L7p:Base64Expression stringValue="QUxM"/>
                            <L7p:VariableToSet stringValue="environment"/>
                        </L7p:SetVariable>
                        <L7p:assertionComment>
                            <L7p:Properties mapValue="included">
                                <L7p:entry>
                                    <L7p:key stringValue="RIGHT.COMMENT"/>
                                    <L7p:value stringValue="// Assign incoming variables to context variables"/>
                                </L7p:entry>
                            </L7p:Properties>
                        </L7p:assertionComment>
                    </wsp:All>
                    <L7p:SetVariable>
                        <L7p:AssertionComment assertionComment="included">
                            <L7p:Properties mapValue="included">
                                <L7p:entry>
                                    <L7p:key stringValue="LEFT.COMMENT"/>
                                    <L7p:value stringValue="API Key"/>
                                </L7p:entry>
                                <L7p:entry>
                                    <L7p:key stringValue="RIGHT.COMMENT"/>
                                    <L7p:value stringValue="XML value for table 'portal_apikey'"/>
                                </L7p:entry>
                            </L7p:Properties>
                        </L7p:AssertionComment>
                        <L7p:Base64Expression stringValue="PGw3OkFwaUtleSB4bWxuczpsNz0iaHR0cDovL25zLmw3dGVjaC5jb20vMjAxMi8wNC9hcGktbWFuYWdlbWVudCI+DQogICAgPGw3Okxhc3RVcGRhdGU+PCFbQ0RBVEFbJHtub3cubWlsbGlzfV1dPjwvbDc6TGFzdFVwZGF0ZT4NCiAgICA8bDc6S2V5PjwhW0NEQVRBWyR7Y2xpZW50X2tleX1dXT48L2w3OktleT4NCiAgICA8bDc6U3RhdHVzPjwhW0NEQVRBWyR7c3RhdHVzfV1dPjwvbDc6U3RhdHVzPg0KICAgIDxsNzpBY2NvdW50UGxhbk1hcHBpbmdJZD48IVtDREFUQVske29yZ2FuaXphdGlvbl9pZH1dXT48L2w3OkFjY291bnRQbGFuTWFwcGluZ0lkPg0KICAgIDxsNzpBY2NvdW50UGxhbk1hcHBpbmdOYW1lPjwhW0NEQVRBWyR7b3JnYW5pemF0aW9ufV1dPjwvbDc6QWNjb3VudFBsYW5NYXBwaW5nTmFtZT4NCiAgICA8bDc6Q3VzdG9tTWV0YURhdGE+PCFbQ0RBVEFbJHtjdXN0b21NZXRhRGF0YX1dXT48L2w3OkN1c3RvbU1ldGFEYXRhPg0KICAgIDxsNzpBcGlzPg0KICAgICAgICAke2FwaV9wbGFuc30NCiAgICA8L2w3OkFwaXM+DQogICAgPGw3OlNlY3JldD48IVtDREFUQVske3NlY3JldH1dXT48L2w3OlNlY3JldD4NCiAgICA8bDc6TGFiZWw+PCFbQ0RBVEFbJHtuYW1lfV1dPjwvbDc6TGFiZWw+DQogICAgPGw3OlBsYXRmb3JtPjwhW0NEQVRBWyR7ZW52aXJvbm1lbnR9XV0+PC9sNzpQbGF0Zm9ybT4NCiAgICA8bDc6U2VjdXJpdHk+DQogICAgICAgIDxsNzpPQXV0aD4NCiAgICAgICAgICAgIDxsNzpDYWxsYmFja1VybD48IVtDREFUQVske29hdXRoX2NhbGxiYWNrfV1dPjwvbDc6Q2FsbGJhY2tVcmw+DQogICAgICAgICAgICA8bDc6U2NvcGU+PCFbQ0RBVEFbJHtvYXV0aF9zY29wZX1dXT48L2w3OlNjb3BlPg0KICAgICAgICAgICAgPGw3OlR5cGU+PCFbQ0RBVEFbJHt0eXBlfV1dPjwvbDc6VHlwZT4NCiAgICAgICAgPC9sNzpPQXV0aD4NCiAgICA8L2w3OlNlY3VyaXR5Pg0KPC9sNzpBcGlLZXk+"/>
                        <L7p:VariableToSet stringValue="value_xml"/>
                    </L7p:SetVariable>
                    <L7p:EncodeDecode>
                        <L7p:SourceVariableName stringValue="value_xml"/>
                        <L7p:TargetDataType variableDataType="string"/>
                        <L7p:TargetVariableName stringValue="value_xml"/>
                        <L7p:TransformType transformType="BASE64_ENCODE"/>
                    </L7p:EncodeDecode>
                    <wsp:OneOrMore wsp:Usage="Required">
                        <wsp:All wsp:Usage="Required">
                            <L7p:Transaction L7p:Usage="Required">
                                <wsp:All wsp:Usage="Required">
                                    <wsp:All wsp:Usage="Required">
                                    <wsp:All wsp:Usage="Required">
                                    <L7p:JdbcQuery>
                                    <L7p:AssertionComment assertionComment="included">
                                    <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="LEFT.COMMENT"/>
                                    <L7p:value stringValue="MySQL"/>
                                    </L7p:entry>
                                    </L7p:Properties>
                                    </L7p:AssertionComment>

                                    <L7p:AssertionFailureEnabled booleanValue="false"/>
                                    <L7p:ConnectionName stringValue="OAuth"/>
                                    <L7p:GenerateXmlResult booleanValue="true"/>
                                    <L7p:MaxRecords intValue="1000"/>
                                    <L7p:SqlQuery stringValueReference="inline"><![CDATA[select custom
           from oauth_client
           where client_ident = ${client_ident}]]></L7p:SqlQuery>
                                    <L7p:VariablePrefix stringValue="query"/>
                                    </L7p:JdbcQuery>
                                    <L7p:SetVariable>
                                    <L7p:Base64Expression stringValue="JHtxdWVyeS54bWxSZXN1bHR9"/>
                                    <L7p:ContentType stringValue="text/xml; charset=utf-8"/>
                                    <L7p:DataType variableDataType="message"/>
                                    <L7p:VariableToSet stringValue="queryCustom"/>
                                    </L7p:SetVariable>
                                    <wsp:OneOrMore wsp:Usage="Required">
                                    <wsp:All wsp:Usage="Required">
                                    <L7p:ResponseXpathAssertion>

                                    <L7p:VariablePrefix stringValue="xpathCustom"/>
                                    <L7p:XmlMsgSrc stringValue="queryCustom"/>

                                    <L7p:XpathExpression xpathExpressionValue="included">

                                    <L7p:Expression stringValue="//L7j:col/text()"/>

                                    <L7p:Namespaces mapValue="included">
                                    <L7p:entry>

                                    <L7p:key stringValue="L7j"/>

                                    <L7p:value stringValue="http://ns.l7tech.com/2012/08/jdbc-query-result"/>
                                    </L7p:entry>
                                    <L7p:entry>

                                    <L7p:key stringValue="s"/>

                                    <L7p:value stringValue="http://schemas.xmlsoap.org/soap/envelope/"/>
                                    </L7p:entry>
                                    </L7p:Namespaces>

                                    <L7p:XpathVersion xpathVersion="XPATH_1_0"/>
                                    </L7p:XpathExpression>
                                    </L7p:ResponseXpathAssertion>
                                    <L7p:SetVariable>

                                    <L7p:Base64Expression stringValue="JHt4cGF0aEN1c3RvbS5yZXN1bHR9"/>

                                    <L7p:VariableToSet stringValue="custom_db"/>
                                    </L7p:SetVariable>
                                    <wsp:OneOrMore wsp:Usage="Required">
                                    <wsp:All wsp:Usage="Required">
                                    <L7p:Regex>

                                    <L7p:AssertionComment assertionComment="included">

                                    <L7p:Properties mapValue="included">
                                    <L7p:entry>

                                    <L7p:key stringValue="RIGHT.COMMENT"/>

                                    <L7p:value stringValue="// Fail if exists"/>
                                    </L7p:entry>
                                    </L7p:Properties>
                                    </L7p:AssertionComment>

                                    <L7p:AutoTarget booleanValue="false"/>

                                    <L7p:OtherTargetMessageVariable stringValue="custom_db"/>

                                    <L7p:ProceedIfPatternMatches booleanValue="false"/>

                                    <L7p:Regex stringValue="apiKey&quot;:[\s]?&quot;[^,\s]*&quot;"/>

                                    <L7p:RegexVar stringValue="custom_db"/>

                                    <L7p:Replacement stringValue=""/>

                                    <L7p:Target target="OTHER"/>
                                    </L7p:Regex>
                                    <L7p:Regex>

                                    <L7p:AutoTarget booleanValue="false"/>

                                    <L7p:OtherTargetMessageVariable stringValue="custom_db"/>

                                    <L7p:Regex stringValue="}$"/>

                                    <L7p:RegexVar stringValue="custom_db"/>

                                    <L7p:Replace booleanValue="true"/>

                                    <L7p:Replacement stringValue="apiKey&quot;:&quot;${client_key}&quot;"/>

                                    <L7p:Target target="OTHER"/>
                                    </L7p:Regex>
                                    </wsp:All>
                                    <L7p:Regex>

                                    <L7p:AutoTarget booleanValue="false"/>

                                    <L7p:OtherTargetMessageVariable stringValue="custom_db"/>
                                    <L7p:Regex stringValue="apiKey&quot;:[\s]?&quot;[^,\s]*&quot;"/>

                                    <L7p:RegexVar stringValue="custom_db"/>
                                    <L7p:Replace booleanValue="true"/>

                                    <L7p:Replacement stringValue="apiKey&quot;:&quot;${client_key}&quot;"/>
                                    <L7p:Target target="OTHER"/>
                                    </L7p:Regex>
                                    </wsp:OneOrMore>
                                    <L7p:SetVariable>

                                    <L7p:Base64Expression stringValue="JHtjdXN0b21fZGJ9"/>

                                    <L7p:VariableToSet stringValue="custom"/>
                                    </L7p:SetVariable>
                                    </wsp:All>
                                    <L7p:TrueAssertion/>
                                    </wsp:OneOrMore>
                                    </wsp:All>
                                    <wsp:OneOrMore wsp:Usage="Required">
                                    <L7p:JdbcQuery>
                                    <L7p:AssertionComment assertionComment="included">
                                    <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="RIGHT.COMMENT"/>
                                    <L7p:value stringValue="// update if exists"/>
                                    </L7p:entry>
                                    </L7p:Properties>
                                    </L7p:AssertionComment>
                                    <L7p:ConnectionName stringValue="OAuth"/>

                                    <L7p:ConvertVariablesToStrings booleanValue="false"/>
                                    <L7p:SqlQuery stringValueReference="inline"><![CDATA[UPDATE oauth_client SET
                name = ${name},
                type = ${type},
                description = ${description},
                organization = ${organization},
                custom = ${custom}
                WHERE client_ident = ${client_ident}]]></L7p:SqlQuery>
                                    </L7p:JdbcQuery>
                                    <L7p:JdbcQuery>
                                    <L7p:AssertionComment assertionComment="included">
                                    <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="RIGHT.COMMENT"/>
                                    <L7p:value stringValue="// insert"/>
                                    </L7p:entry>
                                    </L7p:Properties>
                                    </L7p:AssertionComment>
                                    <L7p:ConnectionName stringValue="OAuth"/>

                                    <L7p:ConvertVariablesToStrings booleanValue="false"/>
                                    <L7p:GenerateXmlResult booleanValue="true"/>
                                    <L7p:SqlQuery stringValueReference="inline"><![CDATA[INSERT INTO oauth_client (client_ident, name, type, description, organization, registered_by, created, custom)
                VALUES (${client_ident}, ${name}, ${type}, ${description}, ${organization}, ${registered_by}, ${now.seconds}, ${custom})]]></L7p:SqlQuery>
                                    </L7p:JdbcQuery>
                                    <L7p:assertionComment>
                                    <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="LEFT.COMMENT"/>
                                    <L7p:value stringValue="DB"/>
                                    </L7p:entry>
                                    </L7p:Properties>
                                    </L7p:assertionComment>
                                    </wsp:OneOrMore>
                                    <L7p:assertionComment>
                                    <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="RIGHT.COMMENT"/>
                                    <L7p:value stringValue="// oauth_client"/>
                                    </L7p:entry>
                                    </L7p:Properties>
                                    </L7p:assertionComment>
                                    </wsp:All>
                                    <wsp:All wsp:Usage="Required">
                                    <wsp:All wsp:Usage="Required">
                                    <L7p:SetVariable>
                                    <L7p:AssertionComment assertionComment="included">
                                    <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="RIGHT.COMMENT"/>
                                    <L7p:value stringValue="masterkey is 0 for default oauth client"/>
                                    </L7p:entry>
                                    </L7p:Properties>
                                    </L7p:AssertionComment>
                                    <L7p:Base64Expression stringValue="MA=="/>
                                    <L7p:VariableToSet stringValue="masterkey_flag"/>
                                    </L7p:SetVariable>
                                    <L7p:JdbcQuery>
                                    <L7p:AssertionComment assertionComment="included">
                                    <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="LEFT.COMMENT"/>
                                    <L7p:value stringValue="MySQL"/>
                                    </L7p:entry>
                                    </L7p:Properties>
                                    </L7p:AssertionComment>

                                    <L7p:AssertionFailureEnabled booleanValue="false"/>
                                    <L7p:ConnectionName stringValue="OAuth"/>
                                    <L7p:GenerateXmlResult booleanValue="true"/>
                                    <L7p:MaxRecords intValue="1000"/>
                                    <L7p:SqlQuery stringValueReference="inline"><![CDATA[select custom
           from oauth_client_key
           where client_key = ${client_key}
           and client_ident=${client_ident}]]></L7p:SqlQuery>
                                    <L7p:VariablePrefix stringValue="query"/>
                                    </L7p:JdbcQuery>
                                    <L7p:SetVariable>
                                    <L7p:Base64Expression stringValue="JHtxdWVyeS54bWxSZXN1bHR9"/>
                                    <L7p:ContentType stringValue="text/xml; charset=utf-8"/>
                                    <L7p:DataType variableDataType="message"/>
                                    <L7p:VariableToSet stringValue="queryCustom"/>
                                    </L7p:SetVariable>
                                    <wsp:OneOrMore wsp:Usage="Required">
                                    <wsp:All wsp:Usage="Required">
                                    <L7p:ResponseXpathAssertion>

                                    <L7p:VariablePrefix stringValue="xpathCustom"/>
                                    <L7p:XmlMsgSrc stringValue="queryCustom"/>

                                    <L7p:XpathExpression xpathExpressionValue="included">

                                    <L7p:Expression stringValue="//L7j:col/text()"/>

                                    <L7p:Namespaces mapValue="included">
                                    <L7p:entry>

                                    <L7p:key stringValue="L7j"/>

                                    <L7p:value stringValue="http://ns.l7tech.com/2012/08/jdbc-query-result"/>
                                    </L7p:entry>
                                    <L7p:entry>

                                    <L7p:key stringValue="s"/>

                                    <L7p:value stringValue="http://schemas.xmlsoap.org/soap/envelope/"/>
                                    </L7p:entry>
                                    </L7p:Namespaces>

                                    <L7p:XpathVersion xpathVersion="XPATH_1_0"/>
                                    </L7p:XpathExpression>
                                    </L7p:ResponseXpathAssertion>
                                    <L7p:SetVariable>

                                    <L7p:Base64Expression stringValue="JHt4cGF0aEN1c3RvbS5yZXN1bHR9"/>

                                    <L7p:VariableToSet stringValue="custom_db"/>
                                    </L7p:SetVariable>
                                    <wsp:OneOrMore wsp:Usage="Required">
                                    <wsp:All wsp:Usage="Required">
                                    <L7p:Regex>

                                    <L7p:AssertionComment assertionComment="included">

                                    <L7p:Properties mapValue="included">
                                    <L7p:entry>

                                    <L7p:key stringValue="RIGHT.COMMENT"/>

                                    <L7p:value stringValue="// Fail if exists"/>
                                    </L7p:entry>
                                    </L7p:Properties>
                                    </L7p:AssertionComment>

                                    <L7p:AutoTarget booleanValue="false"/>

                                    <L7p:OtherTargetMessageVariable stringValue="custom_db"/>

                                    <L7p:ProceedIfPatternMatches booleanValue="false"/>

                                    <L7p:Regex stringValue="apiKey&quot;:[\s]?&quot;[^,\s]*&quot;"/>

                                    <L7p:RegexVar stringValue="custom_db"/>

                                    <L7p:Replacement stringValue=""/>

                                    <L7p:Target target="OTHER"/>
                                    </L7p:Regex>
                                    <L7p:Regex>

                                    <L7p:AutoTarget booleanValue="false"/>

                                    <L7p:OtherTargetMessageVariable stringValue="custom_db"/>

                                    <L7p:Regex stringValue="}$"/>

                                    <L7p:RegexVar stringValue="custom_db"/>

                                    <L7p:Replace booleanValue="true"/>

                                    <L7p:Replacement stringValue="apiKey&quot;:&quot;${client_key}&quot;"/>

                                    <L7p:Target target="OTHER"/>
                                    </L7p:Regex>
                                    </wsp:All>
                                    <L7p:Regex>

                                    <L7p:AutoTarget booleanValue="false"/>

                                    <L7p:OtherTargetMessageVariable stringValue="custom_db"/>
                                    <L7p:Regex stringValue="apiKey&quot;:[\s]?&quot;[^,\s]*&quot;"/>

                                    <L7p:RegexVar stringValue="custom_db"/>
                                    <L7p:Replace booleanValue="true"/>

                                    <L7p:Replacement stringValue="apiKey&quot;:&quot;${client_key}&quot;"/>
                                    <L7p:Target target="OTHER"/>
                                    </L7p:Regex>
                                    </wsp:OneOrMore>
                                    <L7p:SetVariable>

                                    <L7p:Base64Expression stringValue="JHtjdXN0b21fZGJ9"/>

                                    <L7p:VariableToSet stringValue="custom"/>
                                    </L7p:SetVariable>
                                    </wsp:All>
                                    <L7p:TrueAssertion/>
                                    </wsp:OneOrMore>
                                    </wsp:All>
                                    <wsp:OneOrMore wsp:Usage="Required">
                                    <L7p:JdbcQuery>
                                    <L7p:AssertionComment assertionComment="included">
                                    <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="RIGHT.COMMENT"/>
                                    <L7p:value stringValue="// update if exists"/>
                                    </L7p:entry>
                                    </L7p:Properties>
                                    </L7p:AssertionComment>
                                    <L7p:ConnectionName stringValue="OAuth"/>

                                    <L7p:ConvertVariablesToStrings booleanValue="false"/>
                                    <L7p:SqlQuery stringValueReference="inline"><![CDATA[UPDATE oauth_client_key SET
                secret = ${secret},
                scope = ${oauth_scope},
                callback = ${oauth_callback},
                status = ${oauth_client_status},
                client_name = ${name},
                custom = ${custom},
                environment = ${environment},
                masterkey_flag=${masterkey_flag},
                hashing_metadata=${hashing_metadata.mainpart}
                WHERE client_key = ${client_key}
                AND client_ident=${client_ident}]]></L7p:SqlQuery>
                                    </L7p:JdbcQuery>
                                    <L7p:JdbcQuery>
                                    <L7p:AssertionComment assertionComment="included">
                                    <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="RIGHT.COMMENT"/>
                                    <L7p:value stringValue="// insert"/>
                                    </L7p:entry>
                                    </L7p:Properties>
                                    </L7p:AssertionComment>
                                    <L7p:ConnectionName stringValue="OAuth"/>

                                    <L7p:ConvertVariablesToStrings booleanValue="false"/>
                                    <L7p:SqlQuery stringValueReference="inline"><![CDATA[INSERT INTO oauth_client_key (client_key, secret, scope, callback, environment, expiration, status, created, created_by, client_ident, client_name, custom,masterkey_flag,hashing_metadata)
                VALUES (${client_key}, ${secret}, ${oauth_scope}, ${oauth_callback}, ${environment}, ${expiration_otk_client}, ${oauth_client_status}, ${now.seconds}, ${registered_by}, ${client_ident}, ${name}, ${custom},${masterkey_flag},${hashing_metadata.mainpart})]]></L7p:SqlQuery>
                                    </L7p:JdbcQuery>
                                    <L7p:assertionComment>
                                    <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="LEFT.COMMENT"/>
                                    <L7p:value stringValue="DB"/>
                                    </L7p:entry>
                                    </L7p:Properties>
                                    </L7p:assertionComment>
                                    </wsp:OneOrMore>
                                    <L7p:assertionComment>
                                    <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="RIGHT.COMMENT"/>
                                    <L7p:value stringValue="// oauth_client_key"/>
                                    </L7p:entry>
                                    </L7p:Properties>
                                    </L7p:assertionComment>
                                    </wsp:All>
                                    <wsp:OneOrMore wsp:Usage="Required">
                                    <L7p:JdbcQuery>
                                    <L7p:AssertionComment assertionComment="included">
                                    <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="RIGHT.COMMENT"/>
                                    <L7p:value stringValue="// update if exists"/>
                                    </L7p:entry>
                                    </L7p:Properties>
                                    </L7p:AssertionComment>
                                    <L7p:ConnectionName stringValue="OAuth"/>
                                    <L7p:SqlQuery stringValueReference="inline"><![CDATA[UPDATE portal_apikey SET
                apikey_secret = ${secret},
                status = ${status},
                label = ${name},
                apis=${api_ids},
                modified_by=${modified_by},
                value_xml=${value_xml},
                updated=${now.seconds},
                organization=${organization},
                hashing_metadata=${hashing_metadata.mainpart}
                WHERE apikey_pk = ${client_ident}]]></L7p:SqlQuery>
                                    </L7p:JdbcQuery>
                                    <L7p:JdbcQuery>
                                    <L7p:AssertionComment assertionComment="included">
                                    <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="RIGHT.COMMENT"/>
                                    <L7p:value stringValue="// insert"/>
                                    </L7p:entry>
                                    </L7p:Properties>
                                    </L7p:AssertionComment>
                                    <L7p:ConnectionName stringValue="OAuth"/>
                                    <L7p:SqlQuery stringValueReference="inline"><![CDATA[INSERT INTO portal_apikey (apikey_pk, apikey, apikey_secret, status, organization_id, organization, label, created_by, modified_by, created, updated, apis, value_xml,hashing_metadata)
                VALUES (${client_ident}, ${client_key}, ${secret}, ${status}, ${organization_id}, ${organization}, ${name}, ${registered_by}, ${modified_by}, ${now.seconds}, ${now.seconds}, ${api_ids}, ${value_xml},${hashing_metadata.mainpart})]]></L7p:SqlQuery>
                                    </L7p:JdbcQuery>
                                    <L7p:assertionComment>
                                    <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="RIGHT.COMMENT"/>
                                    <L7p:value stringValue="// apikey"/>
                                    </L7p:entry>
                                    </L7p:Properties>
                                    </L7p:assertionComment>
                                    </wsp:OneOrMore>
                                    <wsp:OneOrMore wsp:Usage="Required">
                                    <wsp:All wsp:Usage="Required">
                                    <L7p:EvaluateJsonPathExpression>
                                    <L7p:Expression stringValue="mag"/>

                                    <L7p:OtherTargetMessageVariable stringValue="nextApiKeyJSON"/>
                                    <L7p:Target target="OTHER"/>
                                    <L7p:VariablePrefix stringValue="master_keys"/>
                                    </L7p:EvaluateJsonPathExpression>
                                    <wsp:OneOrMore wsp:Usage="Required">
                                    <L7p:ComparisonAssertion>
                                    <L7p:CaseSensitive booleanValue="false"/>
                                    <L7p:Expression1 stringValue="${master_keys.result}"/>
                                    <L7p:Expression2 stringValue="{&quot;masterKeys&quot;:[]}"/>
                                    <L7p:Predicates predicates="included">
                                    <L7p:item binary="included">

                                    <L7p:CaseSensitive booleanValue="false"/>

                                    <L7p:RightValue stringValue="{&quot;masterKeys&quot;:[]}"/>
                                    </L7p:item>
                                    </L7p:Predicates>
                                    </L7p:ComparisonAssertion>
                                    <L7p:ComparisonAssertion>
                                    <L7p:CaseSensitive booleanValue="false"/>
                                    <L7p:Expression1 stringValue="${master_keys.result}"/>
                                    <L7p:Expression2 stringValue="{&quot;masterKeys&quot;:[{}]}"/>
                                    <L7p:Predicates predicates="included">
                                    <L7p:item binary="included">

                                    <L7p:CaseSensitive booleanValue="false"/>

                                    <L7p:RightValue stringValue="{&quot;masterKeys&quot;:[{}]}"/>
                                    </L7p:item>
                                    </L7p:Predicates>
                                    </L7p:ComparisonAssertion>
                                    </wsp:OneOrMore>
                                    <L7p:assertionComment>
                                    <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="RIGHT.COMMENT"/>
                                    <L7p:value stringValue="// no master-keys"/>
                                    </L7p:entry>
                                    </L7p:Properties>
                                    </L7p:assertionComment>
                                    </wsp:All>
                                    <wsp:All wsp:Usage="Required">
                                    <L7p:EvaluateJsonPathExpression>
                                    <L7p:Expression stringValue="mag.masterKeys"/>

                                    <L7p:OtherTargetMessageVariable stringValue="nextApiKeyJSON"/>
                                    <L7p:Target target="OTHER"/>
                                    <L7p:VariablePrefix stringValue="master_keys"/>
                                    </L7p:EvaluateJsonPathExpression>
                                    <L7p:SetVariable>
                                    <L7p:AssertionComment assertionComment="included">
                                    <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="RIGHT.COMMENT"/>
                                    <L7p:value stringValue="masterkey is 1 for mag clients"/>
                                    </L7p:entry>
                                    </L7p:Properties>
                                    </L7p:AssertionComment>
                                    <L7p:Base64Expression stringValue="MQ=="/>
                                    <L7p:VariableToSet stringValue="masterkey_flag"/>
                                    </L7p:SetVariable>
                                    <L7p:SetVariable>
                                    <L7p:Base64Expression stringValue=""/>
                                    <L7p:ContentType stringValue="application/json; charset=utf-8"/>
                                    <L7p:DataType variableDataType="message"/>
                                    <L7p:VariableToSet stringValue="hashing_metadata"/>
                                    </L7p:SetVariable>
                                    <wsp:OneOrMore wsp:Usage="Required">
                                    <wsp:All wsp:Usage="Required">
                                    <L7p:EvaluateJsonPathExpression>
                                    <L7p:Expression stringValue="mag.scope"/>

                                    <L7p:OtherTargetMessageVariable stringValue="nextApiKeyJSON"/>
                                    <L7p:Target target="OTHER"/>

                                    <L7p:VariablePrefix stringValue="master_key_scope"/>
                                    </L7p:EvaluateJsonPathExpression>
                                    <L7p:ComparisonAssertion>

                                    <L7p:CaseSensitive booleanValue="false"/>
                                    <L7p:Expression1 stringValue="${master_key_scope.result}"/>
                                    <L7p:Expression2 stringValue="false"/>
                                    <L7p:Negate booleanValue="true"/>
                                    <L7p:Operator operator="EMPTY"/>
                                    <L7p:Predicates predicates="included">
                                    <L7p:item binary="included">

                                    <L7p:CaseSensitive booleanValue="false"/>

                                    <L7p:Negated booleanValue="true"/>

                                    <L7p:Operator operator="EMPTY"/>

                                    <L7p:RightValue stringValue="false"/>
                                    </L7p:item>
                                    </L7p:Predicates>
                                    </L7p:ComparisonAssertion>
                                    </wsp:All>
                                    <L7p:SetVariable>

                                    <L7p:Base64Expression stringValue="b29i"/>
                                    <L7p:VariableToSet stringValue="master_key_scope.result"/>
                                    </L7p:SetVariable>
                                    <L7p:assertionComment>
                                    <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="RIGHT.COMMENT"/>
                                    <L7p:value stringValue="// check for scope"/>
                                    </L7p:entry>
                                    </L7p:Properties>
                                    </L7p:assertionComment>
                                    </wsp:OneOrMore>
                                    <wsp:OneOrMore wsp:Usage="Required">
                                    <wsp:All wsp:Usage="Required">
                                    <L7p:EvaluateJsonPathExpression>
                                    <L7p:Expression stringValue="mag.redirectUri"/>

                                    <L7p:OtherTargetMessageVariable stringValue="nextApiKeyJSON"/>
                                    <L7p:Target target="OTHER"/>

                                    <L7p:VariablePrefix stringValue="master_key_redirect_uri"/>
                                    </L7p:EvaluateJsonPathExpression>
                                    <L7p:ComparisonAssertion>

                                    <L7p:CaseSensitive booleanValue="false"/>
                                    <L7p:Expression1 stringValue="${master_key_redirect_uri.result}"/>
                                    <L7p:Expression2 stringValue="false"/>
                                    <L7p:Negate booleanValue="true"/>
                                    <L7p:Operator operator="EMPTY"/>
                                    <L7p:Predicates predicates="included">
                                    <L7p:item binary="included">

                                    <L7p:CaseSensitive booleanValue="false"/>

                                    <L7p:Negated booleanValue="true"/>

                                    <L7p:Operator operator="EMPTY"/>

                                    <L7p:RightValue stringValue="false"/>
                                    </L7p:item>
                                    </L7p:Predicates>
                                    </L7p:ComparisonAssertion>
                                    </wsp:All>
                                    <L7p:SetVariable>

                                    <L7p:Base64Expression stringValue="b29i"/>
                                    <L7p:VariableToSet stringValue="master_key_redirect_uri.result"/>
                                    </L7p:SetVariable>
                                    <L7p:assertionComment>
                                    <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="RIGHT.COMMENT"/>
                                    <L7p:value stringValue="// check for redirect"/>
                                    </L7p:entry>
                                    </L7p:Properties>
                                    </L7p:assertionComment>
                                    </wsp:OneOrMore>
                                    <L7p:ForEachLoop
                                    L7p:Usage="Required"
                                    loopVariable="master_keys.results" variablePrefix="master_key">
                                    <L7p:SetVariable>

                                    <L7p:Base64Expression stringValue="JHttYXN0ZXJfa2V5LmN1cnJlbnR9"/>
                                    <L7p:ContentType stringValue="application/json; charset=utf-8"/>
                                    <L7p:DataType variableDataType="message"/>
                                    <L7p:VariableToSet stringValue="mag_key"/>
                                    </L7p:SetVariable>
                                    <L7p:EvaluateJsonPathExpression>
                                    <L7p:Expression stringValue="masterKey"/>

                                    <L7p:OtherTargetMessageVariable stringValue="mag_key"/>
                                    <L7p:Target target="OTHER"/>
                                    <L7p:VariablePrefix stringValue="masterKey"/>
                                    </L7p:EvaluateJsonPathExpression>
                                    <L7p:EvaluateJsonPathExpression>
                                    <L7p:Expression stringValue="environment"/>

                                    <L7p:OtherTargetMessageVariable stringValue="mag_key"/>
                                    <L7p:Target target="OTHER"/>
                                    <L7p:VariablePrefix stringValue="environment"/>
                                    </L7p:EvaluateJsonPathExpression>
                                    <L7p:ComparisonAssertion>
                                    <L7p:CaseSensitive booleanValue="false"/>
                                    <L7p:Expression1 stringValue="${masterKey.result}"/>
                                    <L7p:Expression2 stringValue="false"/>
                                    <L7p:Negate booleanValue="true"/>
                                    <L7p:Operator operator="EMPTY"/>
                                    <L7p:Predicates predicates="included">
                                    <L7p:item binary="included">

                                    <L7p:CaseSensitive booleanValue="false"/>
                                    <L7p:Negated booleanValue="true"/>

                                    <L7p:Operator operator="EMPTY"/>

                                    <L7p:RightValue stringValue="false"/>
                                    </L7p:item>
                                    </L7p:Predicates>
                                    </L7p:ComparisonAssertion>
                                    <L7p:ComparisonAssertion>
                                    <L7p:CaseSensitive booleanValue="false"/>
                                    <L7p:Expression1 stringValue="${environment.result}"/>
                                    <L7p:Expression2 stringValue="false"/>
                                    <L7p:Negate booleanValue="true"/>
                                    <L7p:Operator operator="EMPTY"/>
                                    <L7p:Predicates predicates="included">
                                    <L7p:item binary="included">

                                    <L7p:CaseSensitive booleanValue="false"/>
                                    <L7p:Negated booleanValue="true"/>

                                    <L7p:Operator operator="EMPTY"/>

                                    <L7p:RightValue stringValue="false"/>
                                    </L7p:item>
                                    </L7p:Predicates>
                                    </L7p:ComparisonAssertion>
                                    <wsp:All wsp:Usage="Required">
                                    <wsp:All wsp:Usage="Required">
                                    <L7p:SetVariable>

                                    <L7p:Base64Expression stringValue="eyJhcGlLZXkiOiIke2NsaWVudF9rZXl9In0="/>

                                    <L7p:VariableToSet stringValue="custom"/>
                                    </L7p:SetVariable>
                                    <L7p:JdbcQuery>

                                    <L7p:AssertionComment assertionComment="included">

                                    <L7p:Properties mapValue="included">
                                    <L7p:entry>

                                    <L7p:key stringValue="LEFT.COMMENT"/>

                                    <L7p:value stringValue="MySQL"/>
                                    </L7p:entry>
                                    </L7p:Properties>
                                    </L7p:AssertionComment>

                                    <L7p:AssertionFailureEnabled booleanValue="false"/>

                                    <L7p:ConnectionName stringValue="OAuth"/>

                                    <L7p:GenerateXmlResult booleanValue="true"/>

                                    <L7p:MaxRecords intValue="1000"/>

                                    <L7p:SqlQuery stringValueReference="inline"><![CDATA[select custom
           from oauth_client_key
           where client_key = ${masterKey.result}
           and client_ident=${client_ident}]]></L7p:SqlQuery>

                                    <L7p:VariablePrefix stringValue="query"/>
                                    </L7p:JdbcQuery>
                                    <L7p:SetVariable>

                                    <L7p:Base64Expression stringValue="JHtxdWVyeS54bWxSZXN1bHR9"/>

                                    <L7p:ContentType stringValue="text/xml; charset=utf-8"/>

                                    <L7p:DataType variableDataType="message"/>

                                    <L7p:VariableToSet stringValue="queryCustom"/>
                                    </L7p:SetVariable>
                                    <wsp:OneOrMore wsp:Usage="Required">
                                    <wsp:All wsp:Usage="Required">
                                    <L7p:ResponseXpathAssertion>

                                    <L7p:VariablePrefix stringValue="xpathCustom"/>

                                    <L7p:XmlMsgSrc stringValue="queryCustom"/>

                                    <L7p:XpathExpression xpathExpressionValue="included">

                                    <L7p:Expression stringValue="//L7j:col/text()"/>

                                    <L7p:Namespaces mapValue="included">
                                    <L7p:entry>

                                    <L7p:key stringValue="L7j"/>

                                    <L7p:value stringValue="http://ns.l7tech.com/2012/08/jdbc-query-result"/>
                                    </L7p:entry>
                                    <L7p:entry>

                                    <L7p:key stringValue="s"/>

                                    <L7p:value stringValue="http://schemas.xmlsoap.org/soap/envelope/"/>
                                    </L7p:entry>
                                    </L7p:Namespaces>

                                    <L7p:XpathVersion xpathVersion="XPATH_1_0"/>
                                    </L7p:XpathExpression>
                                    </L7p:ResponseXpathAssertion>
                                    <L7p:SetVariable>

                                    <L7p:Base64Expression stringValue="JHt4cGF0aEN1c3RvbS5yZXN1bHR9"/>

                                    <L7p:VariableToSet stringValue="custom_db"/>
                                    </L7p:SetVariable>

                                    <wsp:OneOrMore wsp:Usage="Required">

                                    <wsp:All wsp:Usage="Required">
                                    <L7p:Regex>

                                    <L7p:AssertionComment assertionComment="included">

                                    <L7p:Properties mapValue="included">
                                    <L7p:entry>

                                    <L7p:key stringValue="RIGHT.COMMENT"/>

                                    <L7p:value stringValue="// Fail if exists"/>
                                    </L7p:entry>
                                    </L7p:Properties>
                                    </L7p:AssertionComment>

                                    <L7p:AutoTarget booleanValue="false"/>

                                    <L7p:OtherTargetMessageVariable stringValue="custom_db"/>

                                    <L7p:ProceedIfPatternMatches booleanValue="false"/>

                                    <L7p:Regex stringValue="apiKey&quot;:[\s]?&quot;[^,\s]*&quot;"/>

                                    <L7p:RegexVar stringValue="custom_db"/>

                                    <L7p:Replacement stringValue=""/>

                                    <L7p:Target target="OTHER"/>
                                    </L7p:Regex>
                                    <L7p:Regex>

                                    <L7p:AutoTarget booleanValue="false"/>

                                    <L7p:OtherTargetMessageVariable stringValue="custom_db"/>

                                    <L7p:Regex stringValue="}$"/>

                                    <L7p:RegexVar stringValue="custom_db"/>

                                    <L7p:Replace booleanValue="true"/>

                                    <L7p:Replacement stringValue="apiKey&quot;:&quot;${client_key}&quot;"/>

                                    <L7p:Target target="OTHER"/>
                                    </L7p:Regex>
                                    </wsp:All>
                                    <L7p:Regex>

                                    <L7p:AutoTarget booleanValue="false"/>

                                    <L7p:OtherTargetMessageVariable stringValue="custom_db"/>

                                    <L7p:Regex stringValue="apiKey&quot;:[\s]?&quot;[^,\s]*&quot;"/>

                                    <L7p:RegexVar stringValue="custom_db"/>

                                    <L7p:Replace booleanValue="true"/>

                                    <L7p:Replacement stringValue="apiKey&quot;:&quot;${client_key}&quot;"/>

                                    <L7p:Target target="OTHER"/>
                                    </L7p:Regex>
                                    </wsp:OneOrMore>
                                    <L7p:SetVariable>

                                    <L7p:Base64Expression stringValue="JHtjdXN0b21fZGJ9"/>

                                    <L7p:VariableToSet stringValue="custom"/>
                                    </L7p:SetVariable>
                                    </wsp:All>
                                    <L7p:TrueAssertion/>
                                    </wsp:OneOrMore>
                                    </wsp:All>
                                    <wsp:OneOrMore wsp:Usage="Required">
                                    <L7p:JdbcQuery>

                                    <L7p:AssertionComment assertionComment="included">

                                    <L7p:Properties mapValue="included">
                                    <L7p:entry>

                                    <L7p:key stringValue="RIGHT.COMMENT"/>

                                    <L7p:value stringValue="// update if exists"/>
                                    </L7p:entry>
                                    </L7p:Properties>
                                    </L7p:AssertionComment>

                                    <L7p:ConnectionName stringValue="OAuth"/>

                                    <L7p:ConvertVariablesToStrings booleanValue="false"/>

                                    <L7p:SqlQuery stringValueReference="inline"><![CDATA[UPDATE oauth_client_key SET
                scope = ${master_key_scope.result},
                callback = ${master_key_redirect_uri.result},
                status = ${oauth_client_status},
                client_name = ${name},
                custom = ${custom},
                environment = ${environment.result},
                masterkey_flag=${masterkey_flag},
                hashing_metadata=${hashing_metadata.mainpart}
                WHERE client_key = ${masterKey.result}
                AND client_ident=${client_ident}]]></L7p:SqlQuery>
                                    </L7p:JdbcQuery>
                                    <L7p:JdbcQuery>

                                    <L7p:AssertionComment assertionComment="included">

                                    <L7p:Properties mapValue="included">
                                    <L7p:entry>

                                    <L7p:key stringValue="RIGHT.COMMENT"/>

                                    <L7p:value stringValue="// insert"/>
                                    </L7p:entry>
                                    </L7p:Properties>
                                    </L7p:AssertionComment>

                                    <L7p:AssertionFailureEnabled booleanValue="false"/>

                                    <L7p:ConnectionName stringValue="OAuth"/>

                                    <L7p:SqlQuery stringValueReference="inline"><![CDATA[INSERT INTO oauth_client_key (client_key, secret, scope, callback, environment, expiration, status, created, created_by, client_ident, client_name, custom,masterkey_flag,hashing_metadata)
                VALUES (${masterKey.result}, ${masterKey.result}, ${master_key_scope.result}, ${master_key_redirect_uri.result}, ${environment.result}, ${expiration_otk_client_sdk}, ${oauth_client_status}, ${now.seconds}, ${registered_by}, ${client_ident}, ${name}, ${custom},${masterkey_flag},${hashing_metadata.mainpart})]]></L7p:SqlQuery>
                                    </L7p:JdbcQuery>
                                    <L7p:assertionComment>

                                    <L7p:Properties mapValue="included">
                                    <L7p:entry>

                                    <L7p:key stringValue="LEFT.COMMENT"/>

                                    <L7p:value stringValue="DB"/>
                                    </L7p:entry>
                                    <L7p:entry>

                                    <L7p:key stringValue="RIGHT.COMMENT"/>

                                    <L7p:value stringValue="// upsert"/>
                                    </L7p:entry>
                                    </L7p:Properties>
                                    </L7p:assertionComment>
                                    </wsp:OneOrMore>
                                    <L7p:assertionComment>
                                    <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="RIGHT.COMMENT"/>

                                    <L7p:value stringValue="// oauth_client_key"/>
                                    </L7p:entry>
                                    </L7p:Properties>
                                    </L7p:assertionComment>
                                    </wsp:All>
                                    </L7p:ForEachLoop>
                                    <L7p:assertionComment>
                                    <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="RIGHT.COMMENT"/>
                                    <L7p:value stringValue="// master-keys exist"/>
                                    </L7p:entry>
                                    </L7p:Properties>
                                    </L7p:assertionComment>
                                    </wsp:All>
                                    <L7p:assertionComment>
                                    <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="RIGHT.COMMENT"/>
                                    <L7p:value stringValue="// oauth_client_key (mag)"/>
                                    </L7p:entry>
                                    </L7p:Properties>
                                    </L7p:assertionComment>
                                    </wsp:OneOrMore>
                                    <L7p:assertionComment>
                                    <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="RIGHT.COMMENT"/>
                                    <L7p:value stringValue="// Success"/>
                                    </L7p:entry>
                                    </L7p:Properties>
                                    </L7p:assertionComment>
                                </wsp:All>
                            </L7p:Transaction>
                            <wsp:OneOrMore wsp:Usage="Required">
                                <L7p:Encapsulated>
                                    <L7p:EncapsulatedAssertionConfigGuid stringValue="0b6928aa-84ce-4e7a-a85f-00c5a890146c"/>
                                    <L7p:EncapsulatedAssertionConfigName stringValue="Portal API Key Record Cache Upsert"/>
                                </L7p:Encapsulated>
                                <L7p:TrueAssertion>
                                    <L7p:AssertionComment assertionComment="included">
                                    <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="RIGHT.COMMENT"/>
                                    <L7p:value stringValue="// If cache update fail, it still continues with the major process but presents errors in auditing"/>
                                    </L7p:entry>
                                    </L7p:Properties>
                                    </L7p:AssertionComment>
                                </L7p:TrueAssertion>
                                <L7p:assertionComment>
                                    <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="RIGHT.COMMENT"/>
                                    <L7p:value stringValue="// Update cache"/>
                                    </L7p:entry>
                                    </L7p:Properties>
                                </L7p:assertionComment>
                            </wsp:OneOrMore>
                        </wsp:All>
                        <wsp:All wsp:Usage="Required">
                            <L7p:ManipulateMultiValuedVariable>
                                <L7p:SourceVariableName stringValue="client_ident"/>
                                <L7p:TargetVariableName stringValue="failedUpSert.list"/>
                            </L7p:ManipulateMultiValuedVariable>
                            <L7p:SetVariable>
                                <L7p:Base64Expression stringValue="MzAw"/>
                                <L7p:VariableToSet stringValue="error.code"/>
                            </L7p:SetVariable>
                            <L7p:assertionComment>
                                <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="RIGHT.COMMENT"/>
                                    <L7p:value stringValue="// Fail (300)"/>
                                    </L7p:entry>
                                </L7p:Properties>
                            </L7p:assertionComment>
                        </wsp:All>
                        <L7p:assertionComment>
                            <L7p:Properties mapValue="included">
                                <L7p:entry>
                                    <L7p:key stringValue="RIGHT.COMMENT"/>
                                    <L7p:value stringValue="// Queries"/>
                                </L7p:entry>
                            </L7p:Properties>
                        </L7p:assertionComment>
                    </wsp:OneOrMore>
                </wsp:All>
                <L7p:assertionComment>
                    <L7p:Properties mapValue="included">
                        <L7p:entry>
                            <L7p:key stringValue="LEFT.COMMENT"/>
                            <L7p:value stringValue="apikeys"/>
                        </L7p:entry>
                        <L7p:entry>
                            <L7p:key stringValue="RIGHT.COMMENT"/>
                            <L7p:value stringValue="Insert or update API Keys and OAuth clients"/>
                        </L7p:entry>
                    </L7p:Properties>
                </L7p:assertionComment>
            </L7p:ForEachLoop>
            <L7p:assertionComment>
                <L7p:Properties mapValue="included">
                    <L7p:entry>
                        <L7p:key stringValue="RIGHT.COMMENT"/>
                        <L7p:value stringValue="Need to check if count is 0 before proceeding"/>
                    </L7p:entry>
                </L7p:Properties>
            </L7p:assertionComment>
        </wsp:OneOrMore>
        <L7p:CommentAssertion>
            <L7p:Comment stringValue="=== HANDLE BULK SYNC"/>
        </L7p:CommentAssertion>
        <wsp:All wsp:Usage="Required">
            <L7p:EvaluateJsonPathExpression>
                <L7p:Expression stringValue="bulkSync"/>
                <L7p:OtherTargetMessageVariable stringValue="incomingJson"/>
                <L7p:Target target="OTHER"/>
                <L7p:VariablePrefix stringValue="bulkSync"/>
            </L7p:EvaluateJsonPathExpression>
            <L7p:SetVariable>
                <L7p:Base64Expression stringValue="JHtidWxrU3luYy5yZXN1bHR9"/>
                <L7p:VariableToSet stringValue="isBulk"/>
            </L7p:SetVariable>
            <wsp:OneOrMore wsp:Usage="Required">
                <wsp:All wsp:Usage="Required">
                    <L7p:ComparisonAssertion>
                        <L7p:CaseSensitive booleanValue="false"/>
                        <L7p:Expression1 stringValue="${isBulk}"/>
                        <L7p:Expression2 stringValue="false"/>
                        <L7p:Predicates predicates="included">
                            <L7p:item binary="included">
                                <L7p:CaseSensitive booleanValue="false"/>
                                <L7p:RightValue stringValue="false"/>
                            </L7p:item>
                        </L7p:Predicates>
                    </L7p:ComparisonAssertion>
                    <L7p:SetVariable>
                        <L7p:Base64Expression stringValue="aW5jcmVtZW50YWw="/>
                        <L7p:VariableToSet stringValue="updateType"/>
                    </L7p:SetVariable>
                    <L7p:assertionComment>
                        <L7p:Properties mapValue="included">
                            <L7p:entry>
                                <L7p:key stringValue="RIGHT.COMMENT"/>
                                <L7p:value stringValue="// incremental"/>
                            </L7p:entry>
                        </L7p:Properties>
                    </L7p:assertionComment>
                </wsp:All>
                <wsp:All wsp:Usage="Required">
                    <L7p:ComparisonAssertion>
                        <L7p:CaseSensitive booleanValue="false"/>
                        <L7p:Expression1 stringValue="${isBulk}"/>
                        <L7p:Expression2 stringValue="true"/>
                        <L7p:Predicates predicates="included">
                            <L7p:item binary="included">
                                <L7p:CaseSensitive booleanValue="false"/>
                                <L7p:RightValue stringValue="true"/>
                            </L7p:item>
                        </L7p:Predicates>
                    </L7p:ComparisonAssertion>
                    <L7p:SetVariable>
                        <L7p:Base64Expression stringValue="YnVsaw=="/>
                        <L7p:VariableToSet stringValue="updateType"/>
                    </L7p:SetVariable>
                    <L7p:SetVariable>
                        <L7p:Base64Expression stringValue="YnVsaw=="/>
                        <L7p:VariableToSet stringValue="idlist"/>
                    </L7p:SetVariable>
                    <L7p:Transaction L7p:Usage="Required">
                        <L7p:JdbcQuery>
                            <L7p:AssertionFailureEnabled booleanValue="false"/>
                            <L7p:ConnectionName stringValue="OAuth"/>
                            <L7p:ConvertVariablesToStrings booleanValue="false"/>
                            <L7p:SqlQuery stringValue="DELETE FROM oauth_client WHERE client_ident IN (SELECT apikey_pk FROM portal_apikey WHERE updated &lt; ${now.seconds})"/>
                        </L7p:JdbcQuery>
                        <L7p:JdbcQuery>
                            <L7p:AssertionFailureEnabled booleanValue="false"/>
                            <L7p:ConnectionName stringValue="OAuth"/>
                            <L7p:ConvertVariablesToStrings booleanValue="false"/>
                            <L7p:SqlQuery stringValue="DELETE FROM portal_apikey WHERE updated &lt; ${now.seconds}"/>
                        </L7p:JdbcQuery>
                    </L7p:Transaction>
                    <wsp:OneOrMore wsp:Usage="Required">
                        <L7p:Encapsulated>
                            <L7p:AssertionComment assertionComment="included">
                                <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="RIGHT.COMMENT"/>
                                    <L7p:value stringValue="// portal api key cache delete bulk"/>
                                    </L7p:entry>
                                </L7p:Properties>
                            </L7p:AssertionComment>
                            <L7p:EncapsulatedAssertionConfigGuid stringValue="fad87697-323e-4242-9231-a6bd2b3ec469"/>
                            <L7p:EncapsulatedAssertionConfigName stringValue="Portal API Key Record Cache Delete"/>
                        </L7p:Encapsulated>
                        <L7p:TrueAssertion>
                            <L7p:AssertionComment assertionComment="included">
                                <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="RIGHT.COMMENT"/>
                                    <L7p:value stringValue="// If cache deletion fail, it still continues with the major process but presents errors in auditing"/>
                                    </L7p:entry>
                                </L7p:Properties>
                            </L7p:AssertionComment>
                        </L7p:TrueAssertion>
                        <L7p:assertionComment>
                            <L7p:Properties mapValue="included">
                                <L7p:entry>
                                    <L7p:key stringValue="RIGHT.COMMENT"/>
                                    <L7p:value stringValue="// Delete from cache of apiKey record"/>
                                </L7p:entry>
                            </L7p:Properties>
                        </L7p:assertionComment>
                    </wsp:OneOrMore>
                    <L7p:assertionComment>
                        <L7p:Properties mapValue="included">
                            <L7p:entry>
                                <L7p:key stringValue="RIGHT.COMMENT"/>
                                <L7p:value stringValue="// bulk"/>
                            </L7p:entry>
                        </L7p:Properties>
                    </L7p:assertionComment>
                </wsp:All>
                <wsp:All wsp:Usage="Required">
                    <L7p:SetVariable>
                        <L7p:Base64Expression stringValue="MzAw"/>
                        <L7p:VariableToSet stringValue="error.code"/>
                    </L7p:SetVariable>
                    <L7p:FalseAssertion/>
                    <L7p:assertionComment>
                        <L7p:Properties mapValue="included">
                            <L7p:entry>
                                <L7p:key stringValue="RIGHT.COMMENT"/>
                                <L7p:value stringValue="// Fail (300)"/>
                            </L7p:entry>
                        </L7p:Properties>
                    </L7p:assertionComment>
                </wsp:All>
                <L7p:assertionComment>
                    <L7p:Properties mapValue="included">
                        <L7p:entry>
                            <L7p:key stringValue="RIGHT.COMMENT"/>
                            <L7p:value stringValue="// incremental or bulk"/>
                        </L7p:entry>
                    </L7p:Properties>
                </L7p:assertionComment>
            </wsp:OneOrMore>
            <L7p:assertionComment>
                <L7p:Properties mapValue="included">
                    <L7p:entry>
                        <L7p:key stringValue="RIGHT.COMMENT"/>
                        <L7p:value stringValue="// handle sync type"/>
                    </L7p:entry>
                </L7p:Properties>
            </L7p:assertionComment>
        </wsp:All>
        <L7p:SetVariable>
            <L7p:Base64Expression stringValue="ewogInBvcnRhbF9zeW5jIjogewogICJzeW5jVHlwZSI6ICIke3VwZGF0ZVR5cGV9IiwKICAiZGVsZXRlZElkRXJyb3JzIjogWyR7ZmFpbGVkRGVsZXRlLmxpc3R9XSwKICAibmV3T3JVcGRhdGVkRW50aXRpZXNFcnJvcnMiOiBbJHtmYWlsZWRVcFNlcnQubGlzdH1dCiB9Cn0="/>
            <L7p:ContentType stringValue="application/json;charset=utf-8"/>
            <L7p:DataType variableDataType="message"/>
            <L7p:VariableToSet stringValue="resp"/>
        </L7p:SetVariable>
    </wsp:All>
</wsp:Policy>
